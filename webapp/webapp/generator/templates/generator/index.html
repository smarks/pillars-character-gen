{% extends "generator/base.html" %}
{% load skill_filters %}

{% block title %}Pillars Character Editor{% endblock %}

{% block extra_css %}
/* Two-column layout */
.generator-layout {
    display: flex;
    gap: 20px;
    align-items: flex-start;
}
.generator-sidebar {
    width: 300px;
    flex-shrink: 0;
}
.generator-main {
    flex: 1;
    min-width: 0;
}
@media (max-width: 900px) {
    .generator-layout {
        flex-direction: column;
    }
    .generator-sidebar {
        width: 100%;
        order: -1;
    }
}

/* Sidebar styling */
.sidebar-section {
    margin-bottom: 15px;
    padding: 12px;
    border: 1px solid #ccc;
    background: #f9f9f9;
}
.sidebar-section h3 {
    margin: 0 0 10px 0;
    font-size: 1em;
    border-bottom: 1px solid #999;
    padding-bottom: 5px;
}
.sidebar-section .btn {
    width: 100%;
    margin-bottom: 8px;
    text-align: center;
    box-sizing: border-box;
}
.sidebar-section .btn:last-child {
    margin-bottom: 0;
}

/* Focus buttons - inline row */
.focus-buttons {
    display: flex;
    gap: 5px;
}
.focus-buttons .btn {
    flex: 1;
    font-size: 0.85em;
    padding: 8px 4px;
    margin-bottom: 0;
}

/* Track panels */
.track-panel {
    border: 2px solid #ccc;
    padding: 8px 10px;
    margin-bottom: 6px;
    cursor: pointer;
    position: relative;
    font-size: 0.9em;
}
.track-panel:last-child {
    margin-bottom: 0;
}
/* Survivability-based colors: lower = more dangerous (red), higher = safer (green) */
.track-panel.surv-3 { background: #ffcccc; border-color: #cc6666; } /* Most dangerous */
.track-panel.surv-4 { background: #ffe6cc; border-color: #cc9966; }
.track-panel.surv-5 { background: #ffffcc; border-color: #cccc66; }
.track-panel.surv-6 { background: #e6ffcc; border-color: #99cc66; }
.track-panel.surv-7 { background: #ccffcc; border-color: #66cc66; } /* Safest */
.track-panel.selected {
    border-color: #228b22;
    border-width: 3px;
}
.track-panel .track-name {
    font-weight: bold;
}
.track-panel .track-details {
    font-size: 0.85em;
    color: #555;
    margin-top: 3px;
}
.track-panel .track-checkbox {
    position: absolute;
    top: 8px;
    right: 8px;
}

/* Character sheet styling */
.character-sheet {
    background: #e0f4ff;
    border: 1px solid #87ceeb;
    padding: 15px;
}
.character-sheet h3 {
    margin: 0 0 15px 0;
    border-bottom: 1px solid #87ceeb;
    padding-bottom: 5px;
}

/* Editable fields */
.editable-field {
    display: flex;
    align-items: baseline;
    margin-bottom: 8px;
    gap: 10px;
}
.editable-field label {
    font-weight: bold;
    min-width: 100px;
}
.editable-field input,
.editable-field textarea {
    flex: 1;
    padding: 4px 8px;
    font-family: monospace;
    border: 1px solid #87ceeb;
    background: white;
}
.editable-field textarea {
    min-height: 60px;
    resize: vertical;
}

/* Attributes grid */
.attributes-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 15px;
}
.attr-box {
    text-align: center;
    padding: 8px;
    background: white;
    border: 1px solid #87ceeb;
}
.attr-box .attr-name {
    font-weight: bold;
    font-size: 0.9em;
}
.attr-box .attr-value {
    font-size: 1.2em;
    font-weight: bold;
}
.attr-box .attr-mod {
    font-size: 0.85em;
    color: #666;
}

/* Skills display */
.skills-section {
    margin-top: 15px;
}
.skills-list {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 5px;
}
.skill-tag {
    background: #333;
    color: white;
    padding: 2px 8px;
    font-size: 0.85em;
}

/* Details section (year-by-year log) */
.details-section {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #87ceeb;
}
.details-section h4 {
    margin: 0 0 10px 0;
}
.experience-log {
    max-height: 200px;
    overflow-y: auto;
    background: white;
    padding: 8px;
    border: 1px solid #ccc;
    font-size: 0.85em;
}
.year-entry {
    padding: 3px 0;
    border-bottom: 1px dotted #ddd;
}
.year-entry:last-child {
    border-bottom: none;
}

/* Action buttons row */
.action-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}
.action-buttons .btn {
    flex: 1;
}

/* Toggle checkbox styling */
.toggle-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
}
.toggle-row label {
    font-size: 0.9em;
}

/* Warning box */
.warning-box {
    background: #fff3cd;
    border: 1px solid #ffc107;
    padding: 8px;
    margin-bottom: 10px;
    font-size: 0.85em;
}

/* Death notice */
.death-notice {
    background: #fdd;
    border-color: #c44;
    color: #c44;
}

/* Mobile styles */
@media screen and (max-width: 768px) {
    .generator-layout {
        flex-direction: column;
    }
    .generator-sidebar {
        width: 100%;
        order: -1;
    }
    .sidebar-section {
        padding: 10px;
        margin-bottom: 12px;
    }
    .sidebar-section select {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        box-sizing: border-box;
    }
    .focus-buttons {
        flex-direction: column;
    }
    .focus-buttons .btn {
        font-size: 1em;
        padding: 12px;
    }
    .attributes-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    .action-buttons {
        flex-direction: column;
    }
}
{% endblock %}

{% block content %}
<div class="top-bar">
    <h1>Character Editor</h1>
</div>

<form method="post" id="generator-form">
{% csrf_token %}
<div class="generator-layout">
    <!-- Left Sidebar - Controls -->
    <div class="generator-sidebar">
        <!-- Re-roll Character -->
        <div class="sidebar-section">
            <h3>Re-roll Character</h3>
            <div class="focus-buttons">
                <button type="submit" name="action" value="reroll_none" class="btn">No Focus</button>
                <button type="submit" name="action" value="reroll_physical" class="btn">STR/DEX</button>
                <button type="submit" name="action" value="reroll_mental" class="btn">INT/WIS</button>
            </div>
        </div>

        {% if not died %}
        <!-- Number of Years -->
        <div class="sidebar-section">
            <h3>Add Experience</h3>
            <div style="margin-bottom: 10px;">
                <label style="display: block; margin-bottom: 5px;">Number of Years:</label>
                <select name="years" id="years-select" style="width: 100%; padding: 5px; font-family: monospace;">
                    <option value="1">1 year</option>
                    <option value="2">2 years</option>
                    <option value="3">3 years</option>
                    <option value="4">4 years</option>
                    <option value="5" selected>5 years</option>
                    <option value="6">6 years</option>
                    <option value="7">7 years</option>
                    <option value="8">8 years</option>
                    <option value="9">9 years</option>
                    <option value="10">10 years</option>
                </select>
            </div>

            <div id="aging-warning" class="warning-box" style="display: none;">
                <strong>Aging Warning!</strong>
                <p style="margin: 5px 0;">Adding <span id="aging-years"></span> years will result in aging penalties.</p>
            </div>

            <!-- Track selection -->
            <div id="track-panels">
                {% for track in track_info %}
                <div class="track-panel surv-{{ track.survivability }}{% if track.recommended and not selected_track %} selected{% elif selected_track == track.track_key %} selected{% endif %}"
                     data-track="{{ track.track_key }}" data-survivability="{{ track.survivability }}">
                    <input type="radio" name="chosen_track" value="{{ track.track_key }}" class="track-checkbox"
                           {% if track.recommended and not selected_track %}checked{% elif selected_track == track.track_key %}checked{% endif %}>
                    <div class="track-name">{{ track.track }}</div>
                    <div class="track-details">
                        Surv: {{ track.survivability }}+
                    </div>
                </div>
                {% endfor %}
            </div>

            <button type="button" id="add-experience-btn" class="btn primary" style="margin-top: 10px;" onclick="addExperienceAjax()">
                Add {% if has_experience %}More {% endif %}Experience
            </button>

            <!-- Experience feedback area -->
            <div id="experience-feedback" style="display: none; margin-top: 10px; padding: 10px; border-radius: 4px; font-size: 0.85em; max-height: 300px; overflow-y: auto;"></div>
        </div>
        {% endif %}

        <!-- Export dropdown -->
        <div class="sidebar-section">
            <h3>Export Character</h3>
            <select id="export-select" onchange="handleExport(this.value)" style="width: 100%; padding: 8px; font-family: monospace;">
                <option value="">-- Choose Export Format --</option>
                <option value="clipboard">Copy to Clipboard</option>
                <option value="markdown">Download as Markdown (.md)</option>
                <option value="pdf">Download as PDF</option>
            </select>
            <p id="export-status" style="margin-top: 8px; font-size: 0.85em; color: #666;"></p>
        </div>

        {% if died %}
        <div class="sidebar-section death-notice">
            <h3 style="color: #c44;">Character Died</h3>
            <p style="margin: 0; font-size: 0.9em;">Died during prior experience at age {{ current_age }}.</p>
        </div>
        {% endif %}
    </div>

    <!-- Main Content - Character Sheet -->
    <div class="generator-main">
        <div class="character-sheet">
            <h3>Character Preview</h3>

            {% with component_id="gensheet" editable=True show_experience=has_experience %}
            {% include "generator/partials/character_sheet_component.html" %}
            {% endwith %}
        </div>
    </div>
</div>
</form>

<script>
// Check if a track is selected and enable/disable Add Experience button
function updateAddExperienceButton() {
    var addBtn = document.getElementById('add-experience-btn');
    if (!addBtn) return;

    var selectedTrack = document.querySelector('input[name="chosen_track"]:checked');
    if (selectedTrack) {
        addBtn.disabled = false;
        addBtn.title = '';
    } else {
        addBtn.disabled = true;
        addBtn.title = 'Select a skill track first';
    }
}

// Initialize CharacterSheet component for editing
document.addEventListener('DOMContentLoaded', function() {
    if (typeof CharacterSheet !== 'undefined') {
        CharacterSheet.init('gensheet', '{% url "update_session_character" %}', '{{ csrf_token }}');
    }

    // Initialize EncumbranceCalc for equipment tracking
    if (typeof EncumbranceCalc !== 'undefined') {
        EncumbranceCalc.init('gensheet');
    }

    // Check Add Experience button state on load
    updateAddExperienceButton();

    // Home link confirmation for non-authenticated users
    var homeLink = document.getElementById('home-link');
    var isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};

    if (homeLink && !isAuthenticated) {
        homeLink.addEventListener('click', function(e) {
            var confirmed = confirm(
                'You are not logged in. Your character data will be lost if you leave this page.\n\n' +
                'To save your character, log in first.\n\n' +
                'Are you sure you want to leave?'
            );
            if (!confirmed) {
                e.preventDefault();
            }
        });
    }
});

(function() {
    var yearsSelect = document.getElementById('years-select');
    var agingWarning = document.getElementById('aging-warning');
    var agingYearsSpan = document.getElementById('aging-years');
    var trackPanels = document.getElementById('track-panels');

    // Current age from context
    var currentAge = {{ current_age|default:16 }};

    function updateAgingWarning() {
        if (!agingWarning || !yearsSelect) return;
        var selectedYears = parseInt(yearsSelect.value) || 0;
        var finalAge = currentAge + selectedYears;

        if (finalAge > 34) {
            if (agingYearsSpan) agingYearsSpan.textContent = selectedYears;
            agingWarning.style.display = 'block';
        } else {
            agingWarning.style.display = 'none';
        }
    }

    // Track panel click handling - select track on click
    document.querySelectorAll('.track-panel:not(.unavailable)').forEach(function(panel) {
        panel.addEventListener('click', function() {
            var radio = this.querySelector('input[type="radio"]');
            if (radio) {
                radio.checked = true;
                // Update visual state
                document.querySelectorAll('.track-panel').forEach(function(p) {
                    p.classList.remove('selected');
                });
                this.classList.add('selected');
            }
        });
    });

    // Aging warning
    if (yearsSelect) {
        yearsSelect.addEventListener('change', updateAgingWarning);
    }
    updateAgingWarning();
})();

// AJAX-based experience adding with immediate feedback
function addExperienceAjax() {
    var btn = document.getElementById('add-experience-btn');
    var feedback = document.getElementById('experience-feedback');
    var yearsSelect = document.getElementById('years-select');
    var selectedTrack = document.querySelector('input[name="chosen_track"]:checked');

    if (!selectedTrack) {
        feedback.style.display = 'block';
        feedback.style.background = '#fff3cd';
        feedback.style.border = '1px solid #ffc107';
        feedback.innerHTML = '<strong>Select a skill track first</strong>';
        return;
    }

    // Disable button and show loading
    btn.disabled = true;
    btn.textContent = 'Rolling...';
    feedback.style.display = 'block';
    feedback.style.background = '#e3f2fd';
    feedback.style.border = '1px solid #2196f3';
    feedback.innerHTML = '<em>Rolling experience years...</em>';

    // Collect form data
    var formData = new FormData();
    formData.append('years', yearsSelect ? yearsSelect.value : '5');
    formData.append('chosen_track', selectedTrack.value);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    // Get name and age if present
    var nameInput = document.querySelector('input[name="char_name"]');
    var ageInput = document.querySelector('input[name="char_age"]');
    if (nameInput) formData.append('char_name', nameInput.value);
    if (ageInput) formData.append('char_age', ageInput.value);

    fetch('{% url "add_session_experience" %}', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.error) {
            feedback.style.background = '#f8d7da';
            feedback.style.border = '1px solid #dc3545';
            feedback.innerHTML = '<strong>Error:</strong> ' + data.error;
            btn.disabled = false;
            btn.textContent = 'Add Experience';
            return;
        }

        // Build feedback HTML
        var html = '<div style="margin-bottom: 8px;"><strong>' + data.track_name + '</strong> - ' +
                   data.new_yearly_results.length + ' year(s) added</div>';

        // Show each year's result
        data.new_yearly_results.forEach(function(yr) {
            var survResult = yr.survived ?
                '<span style="color: green;">Survived</span>' :
                '<span style="color: red;">Died</span>';
            var rollInfo = 'Roll: ' + yr.surv_roll + (yr.surv_mod >= 0 ? '+' : '') + yr.surv_mod +
                          ' = ' + yr.surv_total + ' vs ' + yr.surv_target + '+';

            html += '<div style="padding: 4px 0; border-bottom: 1px solid #ddd;">' +
                   '<strong>Year ' + yr.year + ':</strong> ' + yr.skill + ' ' +
                   '<span style="font-size: 0.8em; color: #666;">(' + rollInfo + ' ' + survResult + ')</span>';

            // yr.aging is an object like {str: -1, dex: 0, ...} - convert non-zero values to display
            if (yr.aging) {
                var agingParts = [];
                Object.keys(yr.aging).forEach(function(attr) {
                    if (yr.aging[attr]) {
                        agingParts.push(attr.toUpperCase() + ' ' + yr.aging[attr]);
                    }
                });
                if (agingParts.length > 0) {
                    html += ' <span style="color: #c44; font-size: 0.8em;">[Aging: ' + agingParts.join(', ') + ']</span>';
                }
            }
            html += '</div>';
        });

        // Summary
        html += '<div style="margin-top: 8px; font-weight: bold;">Age: ' + data.current_age +
               ' | Total Years: ' + data.total_years + '</div>';

        if (data.died) {
            feedback.style.background = '#f8d7da';
            feedback.style.border = '1px solid #dc3545';
            html += '<div style="margin-top: 8px; color: #c44; font-weight: bold;">CHARACTER DIED</div>';
            btn.disabled = true;
            btn.textContent = 'Character Deceased';
        } else {
            feedback.style.background = '#d4edda';
            feedback.style.border = '1px solid #28a745';
            btn.disabled = false;
            btn.textContent = 'Add More Experience';
        }

        feedback.innerHTML = html;

        // Update the age input field with the new current age
        var ageInput = document.querySelector('input[name="char_age"]');
        if (ageInput && data.current_age) {
            ageInput.value = data.current_age;
        }

        // Update the skills list in the character sheet
        if (data.all_skills && data.all_skills.length > 0) {
            updateSkillsList(data.all_skills);
        }

        // Update the Character Log section at the bottom of the page
        updateCharacterLog(data);
    })
    .catch(function(err) {
        feedback.style.background = '#f8d7da';
        feedback.style.border = '1px solid #dc3545';
        feedback.innerHTML = '<strong>Error:</strong> ' + err.message;
        btn.disabled = false;
        btn.textContent = 'Add Experience';
    });
}

// Update the skills list in the character sheet
function updateSkillsList(skills) {
    var skillsList = document.getElementById('gensheet-skills-list');
    if (!skillsList) return;

    // Clear existing skills
    skillsList.innerHTML = '';

    // Consolidate skills (count duplicates)
    var skillCounts = {};
    skills.forEach(function(skill) {
        skillCounts[skill] = (skillCounts[skill] || 0) + 1;
    });

    // Build skill items
    Object.keys(skillCounts).sort().forEach(function(skillName) {
        var count = skillCounts[skillName];
        var displayName = count > 1 ? skillName + ' ' + count : skillName;

        var li = document.createElement('li');
        li.className = 'skill-item';
        li.dataset.skillName = skillName;
        li.innerHTML = '<span class="skill-tag editable" onclick="CharacterSheet.startRenameSkill(\'gensheet\', this)" title="Click to rename">' +
                       displayName + '</span>';
        skillsList.appendChild(li);
    });
}

// Update the Character Log section with new experience data
function updateCharacterLog(data) {
    var logSection = document.querySelector('.character-log-section');
    var experienceLog = logSection ? logSection.querySelector('.experience-log') : null;

    // If Character Log section doesn't exist, create it
    if (!logSection) {
        var sheetComponent = document.querySelector('.character-sheet-component');
        if (!sheetComponent) return;

        logSection = document.createElement('div');
        logSection.className = 'sheet-section character-log-section';
        logSection.innerHTML = '<h2>Character Log</h2>';
        sheetComponent.appendChild(logSection);
    }

    // Find or create experience summary
    var summary = logSection.querySelector('.experience-summary');
    if (!summary) {
        summary = document.createElement('div');
        summary.className = 'experience-summary';
        // Insert after h2
        var h2 = logSection.querySelector('h2');
        if (h2.nextSibling) {
            logSection.insertBefore(summary, h2.nextSibling);
        } else {
            logSection.appendChild(summary);
        }
    }

    // Update summary
    summary.innerHTML = '<div class="summary-row">' +
        '<span class="summary-label">Prior Experience:</span> ' +
        '<span class="summary-value">' + data.total_years + ' years as ' + data.track_name + '</span> ' +
        '<span class="summary-ages">(Age 16 â†’ ' + data.current_age + ')</span>' +
        (data.died ? ' <span class="died-badge">DECEASED</span>' : '') +
        '</div>';

    // Find or create Prior Experience Log header and experience-log div
    var expHeader = logSection.querySelector('h3.prior-exp-header');
    if (!expHeader) {
        // Check if generation log exists to insert after it
        var genLog = logSection.querySelector('.generation-log');
        expHeader = document.createElement('h3');
        expHeader.className = 'prior-exp-header';
        expHeader.textContent = 'Prior Experience Log';

        if (genLog) {
            genLog.after(expHeader);
        } else {
            logSection.appendChild(expHeader);
        }
    }

    // Find or create experience-log div
    if (!experienceLog) {
        experienceLog = document.createElement('div');
        experienceLog.className = 'experience-log';
        expHeader.after(experienceLog);
    }

    // Append new year entries
    data.new_yearly_results.forEach(function(yr) {
        var yearDiv = document.createElement('div');
        yearDiv.className = 'year-entry' + (yr.survived ? '' : ' died');

        var agingHtml = '';
        // yr.aging is an object like {str: -1, dex: 0, ...} - convert non-zero values to display
        if (yr.aging) {
            Object.keys(yr.aging).forEach(function(attr) {
                if (yr.aging[attr]) {
                    agingHtml += '| <span class="aging-penalty">' + attr.toUpperCase() + ' ' + yr.aging[attr] + '</span> ';
                }
            });
        }

        yearDiv.innerHTML = '<strong>Year ' + yr.year + ':</strong> ' + yr.skill + ' | ' +
            'Survival: ' + yr.surv_roll + (yr.surv_mod >= 0 ? '+' : '') + yr.surv_mod + '=' + yr.surv_total +
            ' vs ' + yr.surv_target + '+ ' +
            '[' + (yr.survived ? '<span class="survived">Survived</span>' : '<span class="died-text">DIED</span>') + '] ' +
            agingHtml;

        experienceLog.appendChild(yearDiv);
    });
}

function handleExport(format) {
    var select = document.getElementById('export-select');
    var status = document.getElementById('export-status');

    if (!format) return;

    if (format === 'clipboard') {
        // Fetch full character data as markdown for clipboard
        fetch('{% url "export_session_character_markdown" %}')
            .then(response => response.text())
            .then(content => {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(content).then(function() {
                        status.textContent = 'Copied to clipboard!';
                        status.style.color = 'green';
                        setTimeout(function() {
                            status.textContent = '';
                            select.value = '';
                        }, 2000);
                    });
                } else {
                    // Fallback for older browsers
                    var textarea = document.createElement('textarea');
                    textarea.value = content;
                    textarea.style.position = 'fixed';
                    textarea.style.left = '-9999px';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    status.textContent = 'Copied to clipboard!';
                    status.style.color = 'green';
                    setTimeout(function() {
                        status.textContent = '';
                        select.value = '';
                    }, 2000);
                }
            })
            .catch(function(err) {
                status.textContent = 'Error copying: ' + err;
                status.style.color = 'red';
            });
    } else if (format === 'markdown') {
        window.location.href = '{% url "export_session_character_markdown" %}';
        status.textContent = 'Downloading...';
        setTimeout(function() {
            status.textContent = '';
            select.value = '';
        }, 2000);
    } else if (format === 'pdf') {
        window.location.href = '{% url "export_session_character_pdf" %}';
        status.textContent = 'Downloading...';
        setTimeout(function() {
            status.textContent = '';
            select.value = '';
        }, 2000);
    }
}

// Listen for track info updates from character sheet component
document.addEventListener('trackInfoUpdated', function(e) {
    var trackInfo = e.detail.trackInfo;
    var trackPanels = document.getElementById('track-panels');

    if (!trackPanels || !trackInfo) return;

    // Rebuild track panels
    trackPanels.innerHTML = '';

    trackInfo.forEach(function(track) {
        var panelClass = 'track-panel surv-' + track.survivability;
        if (track.recommended) {
            panelClass += ' selected';
        }

        var panel = document.createElement('div');
        panel.className = panelClass;
        panel.dataset.track = track.track_key;
        panel.dataset.survivability = track.survivability;

        var html = '';
        var checked = track.recommended ? 'checked' : '';
        html += '<input type="radio" name="chosen_track" value="' + track.track_key + '" class="track-checkbox" ' + checked + '>';
        html += '<div class="track-name">' + track.track + '</div>';
        html += '<div class="track-details">';
        html += 'Surv: ' + track.survivability + '+';
        html += '</div>';

        panel.innerHTML = html;

        // Add click handler
        panel.addEventListener('click', function() {
            var radio = this.querySelector('input[type="radio"]');
            if (radio) {
                radio.checked = true;
                // Update visual state
                trackPanels.querySelectorAll('.track-panel').forEach(function(p) {
                    p.classList.remove('selected');
                });
                this.classList.add('selected');
                // Update Add Experience button state
                updateAddExperienceButton();
            }
        });

        trackPanels.appendChild(panel);
    });

    // Update Add Experience button state after rebuilding tracks
    updateAddExperienceButton();
});
</script>
{% endblock %}
