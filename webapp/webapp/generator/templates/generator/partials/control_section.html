<div class="section">
    <h3>What would you like to do?</h3>
    <div class="control-row">
        <label>Years:</label>
        <select name="years" id="years-select">
            <option value="1">1 year</option>
            <option value="2">2 years</option>
            <option value="3">3 years</option>
            <option value="4">4 years</option>
            <option value="5" selected>5 years</option>
            <option value="6">6 years</option>
            <option value="7">7 years</option>
            <option value="8">8 years</option>
            <option value="9">9 years</option>
            <option value="10">10 years</option>
        </select>
        <span>— or —</span>
        <label>
            <input type="checkbox" name="interactive_mode" id="interactive-checkbox">
            Interactive Mode (year by year)
        </label>
    </div>

    <div id="aging-warning" class="warning-box" style="display: none;">
        <h4>Aging Warning!</h4>
        <p>Adding <span id="aging-years"></span> years will push your character past age 34, resulting in aging penalties:</p>
        <ul>
            <li>Age 35: STR -1, DEX -1</li>
            <li>Age 39: CON -1</li>
            <li>Age 67+: Additional STR -1, DEX -1, INT -1, WIS -1, CON -1</li>
        </ul>
    </div>

    <div class="button-group button-group-main">
        {% if not died %}
        <button type="submit" name="action" value="add_experience" class="primary">Add {% if has_experience %}More {% endif %}Experience</button>
        {% endif %}
        <button type="submit" name="action" value="finish" class="success">Finish Character</button>
    </div>

    <div class="button-group roll-buttons">
        <button type="button" class="roll-btn" data-action="reroll_none">Roll (No Focus)</button>
        <button type="button" class="roll-btn" data-action="reroll_physical">Roll (STR/DEX Focus)</button>
        <button type="button" class="roll-btn" data-action="reroll_mental">Roll (INT/WIS Focus)</button>
    </div>
</div>

<script>
(function() {
    var yearsSelect = document.getElementById('years-select');
    var interactiveCheckbox = document.getElementById('interactive-checkbox');
    var agingWarning = document.getElementById('aging-warning');
    var agingYearsSpan = document.getElementById('aging-years');

    // Current age from context (16 + years_completed), default to 16 if not set
    var currentAge = {{ current_age|default:16 }};

    function updateAgingWarning() {
        if (!agingWarning) return;

        var selectedYears = parseInt(yearsSelect.value) || 0;
        var finalAge = currentAge + selectedYears;

        // Show warning if adding years would push past 34
        if (finalAge > 34 && currentAge <= 34) {
            agingYearsSpan.textContent = selectedYears;
            agingWarning.style.display = 'block';
        } else if (finalAge > 34 && currentAge > 34) {
            // Already past 34, warn about additional aging
            agingYearsSpan.textContent = selectedYears;
            agingWarning.querySelector('p').textContent =
                'Adding ' + selectedYears + ' years will result in additional aging penalties (current age: ' + currentAge + '):';
            agingWarning.style.display = 'block';
        } else {
            agingWarning.style.display = 'none';
        }
    }

    // Disable years selector when interactive mode is checked
    interactiveCheckbox.addEventListener('change', function() {
        yearsSelect.disabled = this.checked;
        if (this.checked) {
            agingWarning.style.display = 'none';
        } else {
            updateAgingWarning();
        }
    });

    // Update warning when years selection changes
    yearsSelect.addEventListener('change', updateAgingWarning);

    // Initial check
    updateAgingWarning();
})();

// Roll button handling - check for unsaved changes before rolling
(function() {
    var rollButtons = document.querySelectorAll('.roll-btn');
    var form = document.querySelector('form');
    var isLoggedIn = {% if user.is_authenticated %}true{% else %}false{% endif %};
    var hasExperience = {% if has_experience %}true{% else %}false{% endif %};
    var quickSaveUrl = '{% url "quick_save_character" %}';
    var csrfToken = '{{ csrf_token }}';

    function doRoll(action) {
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'action';
        input.value = action;
        form.appendChild(input);
        form.submit();
    }

    function quickSaveAndRoll(action) {
        fetch(quickSaveUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                alert('Character saved as "' + data.name + '"');
                doRoll(action);
            } else {
                alert('Failed to save: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(function(err) {
            alert('Error saving character: ' + err.message);
        });
    }

    rollButtons.forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            var action = this.getAttribute('data-action');

            if (hasExperience) {
                if (isLoggedIn) {
                    var save = confirm('You have unsaved changes. Would you like to save this character before rolling a new one?\n\nClick OK to save, Cancel to discard.');
                    if (save) {
                        quickSaveAndRoll(action);
                    } else {
                        doRoll(action);
                    }
                } else {
                    var proceed = confirm('You have unsaved changes that will be lost. Continue?');
                    if (proceed) {
                        doRoll(action);
                    }
                }
            } else {
                doRoll(action);
            }
        });
    });
})();
</script>
