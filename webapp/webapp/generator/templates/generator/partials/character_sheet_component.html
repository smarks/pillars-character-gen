{% comment %}
Reusable Character Sheet Component

Required context variables:
- char_data: dict with character data (attributes, appearance, etc.)
- skills: list of consolidated skill strings
- editable: bool - whether fields can be edited
- show_experience: bool - whether to show prior experience section
- yearly_results: list of year result dicts (optional)
- years_served: int (optional)
- current_age: int (optional, defaults to 16)
- died: bool (optional)

Optional context variables:
- character: SavedCharacter model instance (for saved characters)
- component_id: unique ID prefix for this instance (default: 'cs')
- save_url: URL for auto-save (required if editable=True)
- csrf_token: CSRF token (required if editable=True)
- aging_penalties: dict with 'str', 'dex', 'int', 'wis', 'con' keys (optional)

Attribute display variables (computed by view):
- str_display, dex_display, etc.: formatted attribute values
- str_mod, dex_mod, etc.: attribute modifiers
{% endcomment %}

{% load static %}

<div class="character-sheet-component" id="{{ component_id|default:'cs' }}-container">
    {% if component_id == 'gensheet' %}
    <!-- Name (only shown in generator view - character sheet has name in header) -->
    <div class="editable-field" style="margin-bottom: 15px;">
        <label>Name:</label>
        <input type="text" name="char_name" id="char-name" data-field="name"
               value="{{ char_data.name|default:'' }}" placeholder="Enter character name">
    </div>
    {% endif %}

    {% if component_id == 'gensheet' or component_id == 'character_sheet' %}
    <!-- Age and Race -->
    <div class="editable-field" style="margin-bottom: 15px; display: flex; gap: 25px; align-items: flex-start;">
        <div style="flex: 0 0 100px;">
            <label>Age:</label>
            {% if editable %}
            <input type="number" name="char_age" id="{{ component_id }}-char-age" data-field="age"
                   value="{{ char_data.age|default:current_age|default:16 }}" placeholder="Age"
                   min="0" inputmode="numeric" style="width: 100%; padding: 6px 8px; font-family: inherit; font-size: 14px; border: 1px solid #ccc;">
            {% else %}
            <span class="field-value">{{ char_data.age|default:current_age|default:16 }}</span>
            {% endif %}
        </div>
        <div style="flex: 0 0 200px;">
            <label>Race:</label>
            {% if editable %}
            <select name="char_race" id="{{ component_id }}-char-race" data-field="race"
                    style="width: 100%; padding: 6px 8px; font-family: inherit; font-size: 14px; border: 1px solid #ccc; margin-bottom: 5px;">
                <option value="">-- Select Race --</option>
                <option value="human" {% if char_data.race == 'human' %}selected{% endif %}>Human</option>
                <option value="elf" {% if char_data.race == 'elf' %}selected{% endif %}>Elf</option>
                <option value="dwarf" {% if char_data.race == 'dwarf' %}selected{% endif %}>Dwarf</option>
                <option value="giant" {% if char_data.race == 'giant' %}selected{% endif %}>Giant</option>
                <option value="other" {% if char_data.race and char_data.race != 'human' and char_data.race != 'elf' and char_data.race != 'dwarf' and char_data.race != 'giant' %}selected{% endif %}>Other</option>
            </select>
            <input type="text" name="char_race_other" id="{{ component_id }}-char-race-other" data-field="race"
                   value="{% if char_data.race and char_data.race != 'human' and char_data.race != 'elf' and char_data.race != 'dwarf' and char_data.race != 'giant' %}{{ char_data.race }}{% endif %}"
                   placeholder="Enter custom race"
                   style="width: 100%; padding: 6px 8px; font-family: inherit; font-size: 14px; border: 1px solid #ccc; display: none;">
            {% else %}
            <span class="field-value">{{ char_data.race|default:'Human' }}</span>
            {% endif %}
        </div>
    </div>
    <!-- Description -->
    <div class="editable-field" style="margin-bottom: 15px;">
        <label>Description:</label>
        {% if editable %}
        <textarea name="char_description" id="{{ component_id }}-char-description" data-field="description"
                  placeholder="Enter character description" rows="3" style="width: 100%; padding: 6px 8px; font-family: inherit; font-size: 14px; border: 1px solid #ccc; resize: vertical;">{{ char_data.description|default:'' }}</textarea>
        {% else %}
        <div class="field-value">{{ char_data.description|default:'No description' }}</div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Attributes Section -->
    <div class="sheet-section">
        <h2>Attributes</h2>
        {% if editable %}
        <p class="section-help">Values 1-18 are integers. Above 18, use decimal notation: 18.10, 18.20, ... 18.100 = 19</p>
        {% endif %}

        <div class="attributes-grid">
            <div class="attr-box">
                <label>STR</label>
                <div class="attr-values">
                    {% if editable %}
                    <input type="text" class="attr-input" data-field="attributes.STR" data-attr="true"
                           value="{{ str_display|default:char_data.attributes.STR }}" inputmode="numeric">
                    {% else %}
                    <span class="attr-value">{{ str_display|default:char_data.attributes.STR }}</span>
                    {% endif %}
                    {% if aging_penalties.str|default:0 %}
                    <span class="adjusted-attr" title="Effective value after aging ({{ aging_penalties.str }} from aging)">
                        → <span class="adjusted-value" data-computed="str_adjusted">{{ str_adjusted|default:char_data.attributes.STR }}</span>
                        <span class="adj-mod" data-computed="str_adj_mod">({% if str_adj_mod >= 0 %}+{% endif %}{{ str_adj_mod|default:"0" }})</span>
                    </span>
                    {% else %}
                    <span class="modifier" data-computed="str_mod">({% if str_mod >= 0 %}+{% endif %}{{ str_mod|default:"0" }})</span>
                    {% endif %}
                </div>
            </div>
            <div class="attr-box">
                <label>DEX</label>
                <div class="attr-values">
                    {% if editable %}
                    <input type="text" class="attr-input" data-field="attributes.DEX" data-attr="true"
                           value="{{ dex_display|default:char_data.attributes.DEX }}" inputmode="numeric">
                    {% else %}
                    <span class="attr-value">{{ dex_display|default:char_data.attributes.DEX }}</span>
                    {% endif %}
                    {% if aging_penalties.dex|default:0 %}
                    <span class="adjusted-attr" title="Effective value after aging ({{ aging_penalties.dex }} from aging)">
                        → <span class="adjusted-value" data-computed="dex_adjusted">{{ dex_adjusted|default:char_data.attributes.DEX }}</span>
                        <span class="adj-mod" data-computed="dex_adj_mod">({% if dex_adj_mod >= 0 %}+{% endif %}{{ dex_adj_mod|default:"0" }})</span>
                    </span>
                    {% else %}
                    <span class="modifier" data-computed="dex_mod">({% if dex_mod >= 0 %}+{% endif %}{{ dex_mod|default:"0" }})</span>
                    {% endif %}
                </div>
            </div>
            <div class="attr-box">
                <label>INT</label>
                <div class="attr-values">
                    {% if editable %}
                    <input type="text" class="attr-input" data-field="attributes.INT" data-attr="true"
                           value="{{ int_display|default:char_data.attributes.INT }}" inputmode="numeric">
                    {% else %}
                    <span class="attr-value">{{ int_display|default:char_data.attributes.INT }}</span>
                    {% endif %}
                    {% if aging_penalties.int|default:0 %}
                    <span class="adjusted-attr" title="Effective value after aging ({{ aging_penalties.int }} from aging)">
                        → <span class="adjusted-value" data-computed="int_adjusted">{{ int_adjusted|default:char_data.attributes.INT }}</span>
                        <span class="adj-mod" data-computed="int_adj_mod">({% if int_adj_mod >= 0 %}+{% endif %}{{ int_adj_mod|default:"0" }})</span>
                    </span>
                    {% else %}
                    <span class="modifier" data-computed="int_mod">({% if int_mod >= 0 %}+{% endif %}{{ int_mod|default:"0" }})</span>
                    {% endif %}
                </div>
            </div>
            <div class="attr-box">
                <label>WIS</label>
                <div class="attr-values">
                    {% if editable %}
                    <input type="text" class="attr-input" data-field="attributes.WIS" data-attr="true"
                           value="{{ wis_display|default:char_data.attributes.WIS }}" inputmode="numeric">
                    {% else %}
                    <span class="attr-value">{{ wis_display|default:char_data.attributes.WIS }}</span>
                    {% endif %}
                    {% if aging_penalties.wis|default:0 %}
                    <span class="adjusted-attr" title="Effective value after aging ({{ aging_penalties.wis }} from aging)">
                        → <span class="adjusted-value" data-computed="wis_adjusted">{{ wis_adjusted|default:char_data.attributes.WIS }}</span>
                        <span class="adj-mod" data-computed="wis_adj_mod">({% if wis_adj_mod >= 0 %}+{% endif %}{{ wis_adj_mod|default:"0" }})</span>
                    </span>
                    {% else %}
                    <span class="modifier" data-computed="wis_mod">({% if wis_mod >= 0 %}+{% endif %}{{ wis_mod|default:"0" }})</span>
                    {% endif %}
                </div>
            </div>
            <div class="attr-box">
                <label>CON</label>
                <div class="attr-values">
                    {% if editable %}
                    <input type="text" class="attr-input" data-field="attributes.CON" data-attr="true"
                           value="{{ con_display|default:char_data.attributes.CON }}" inputmode="numeric">
                    {% else %}
                    <span class="attr-value">{{ con_display|default:char_data.attributes.CON }}</span>
                    {% endif %}
                    {% if aging_penalties.con|default:0 %}
                    <span class="adjusted-attr" title="Effective value after aging ({{ aging_penalties.con }} from aging)">
                        → <span class="adjusted-value" data-computed="con_adjusted">{{ con_adjusted|default:char_data.attributes.CON }}</span>
                        <span class="adj-mod" data-computed="con_adj_mod">({% if con_adj_mod >= 0 %}+{% endif %}{{ con_adj_mod|default:"0" }})</span>
                    </span>
                    {% else %}
                    <span class="modifier" data-computed="con_mod">({% if con_mod >= 0 %}+{% endif %}{{ con_mod|default:"0" }})</span>
                    {% endif %}
                </div>
            </div>
            <div class="attr-box">
                <label>CHR</label>
                <div class="attr-values">
                    {% if editable %}
                    <input type="text" class="attr-input" data-field="attributes.CHR" data-attr="true"
                           value="{{ chr_display|default:char_data.attributes.CHR }}" inputmode="numeric">
                    {% else %}
                    <span class="attr-value">{{ chr_display|default:char_data.attributes.CHR }}</span>
                    {% endif %}
                    <span class="modifier" data-computed="chr_mod">({% if chr_mod >= 0 %}+{% endif %}{{ chr_mod|default:"0" }})</span>
                </div>
            </div>
        </div>

        <div class="derived-stats">
            <div class="derived-stat">
                <label>Fatigue Points</label>
                <span class="value" data-computed="fatigue_points">{{ char_data.attributes.fatigue_points }}</span>
            </div>
            <div class="derived-stat">
                <label>Body Points</label>
                <span class="value" data-computed="body_points">{{ char_data.attributes.body_points }}</span>
            </div>
        </div>
    </div>

    <!-- Biographical Section -->
    <div class="sheet-section">
        <h2>Biographical</h2>
        <div class="field-row">
            <label>Appearance:</label>
            {% if editable %}
            <input type="text" data-field="appearance" value="{{ char_data.appearance|default:'' }}">
            {% else %}
            <span class="field-value">{{ char_data.appearance|default:'-' }}</span>
            {% endif %}
        </div>
        <div class="field-row">
            <label>Height:</label>
            {% if editable %}
            <input type="text" data-field="height" value="{{ char_data.height|default:'' }}"
                   class="numeric-field" placeholder="e.g., 5'8&quot; or 68">
            {% else %}
            <span class="field-value">{{ char_data.height|default:'-' }}</span>
            {% endif %}
        </div>
        <div class="field-row">
            <label>Weight:</label>
            {% if editable %}
            <input type="text" data-field="weight" value="{{ char_data.weight|default:'' }}"
                   class="numeric-field" placeholder="e.g., 150">
            {% else %}
            <span class="field-value">{{ char_data.weight|default:'-' }}</span>
            {% endif %}
        </div>
    </div>

    <!-- Background Section -->
    <div class="sheet-section">
        <h2>Background</h2>
        <div class="field-row">
            <label>Provenance:</label>
            {% if editable %}
            <input type="text" data-field="provenance" value="{{ char_data.provenance|default:'' }}">
            {% else %}
            <span class="field-value">{{ char_data.provenance|default:'-' }}</span>
            {% endif %}
        </div>
        <div class="field-row">
            <label>Location:</label>
            {% if editable %}
            <input type="text" data-field="location" value="{{ char_data.location|default:'' }}">
            {% else %}
            <span class="field-value">{{ char_data.location|default:'-' }}</span>
            {% endif %}
        </div>
        <div class="field-row">
            <label>Literacy:</label>
            {% if editable %}
            <select data-field="literacy">
                <option value="None" {% if char_data.literacy == 'None' or not char_data.literacy %}selected{% endif %}>None</option>
                <option value="Basic" {% if 'Basic' in char_data.literacy|default:'' %}selected{% endif %}>Basic</option>
                <option value="Literate" {% if 'Literate' in char_data.literacy|default:'' %}selected{% endif %}>Literate</option>
            </select>
            {% else %}
            <span class="field-value">{{ char_data.literacy|default:'None' }}</span>
            {% endif %}
        </div>
        <div class="field-row">
            <label>Wealth:</label>
            {% if editable %}
            <select data-field="wealth_level">
                <option value="Destitute" {% if char_data.wealth_level == 'Destitute' %}selected{% endif %}>Destitute</option>
                <option value="Poor" {% if char_data.wealth_level == 'Poor' %}selected{% endif %}>Poor</option>
                <option value="Moderate" {% if char_data.wealth_level == 'Moderate' or not char_data.wealth_level %}selected{% endif %}>Moderate</option>
                <option value="Comfortable" {% if char_data.wealth_level == 'Comfortable' %}selected{% endif %}>Comfortable</option>
                <option value="Rich" {% if char_data.wealth_level == 'Rich' %}selected{% endif %}>Rich</option>
            </select>
            {% else %}
            <span class="field-value">{{ char_data.wealth|default:char_data.wealth_level|default:'Moderate' }}</span>
            {% endif %}
        </div>
    </div>

    <!-- Skills Section (separate div as requested) -->
    <div class="sheet-section skills-section">
        <h2>Skills</h2>

        <!-- Experience and Free Points Display -->
        <div class="skill-points-info" id="{{ component_id|default:'cs' }}-skill-points-info">
            <div class="xp-display">
                <label>Experience:</label>
                <span class="xp-value" id="{{ component_id|default:'cs' }}-total-xp">{{ total_xp|default:0 }} XP</span>
            </div>
            <div class="free-points-display">
                <label>Available Skill Points:</label>
                <span class="free-points-value" id="{{ component_id|default:'cs' }}-free-points">{{ free_skill_points|default:0 }}</span>
                {% if free_skill_points > 0 and editable %}
                <span class="help-text">Click +1 next to a skill to allocate a point.</span>
                {% endif %}
            </div>
            {% if free_skill_points > 0 %}
            <div class="free-points-banner">
                <strong><span id="{{ component_id|default:'cs' }}-free-points-banner">{{ free_skill_points }}</span> Free Skill Points Available!</strong>
                {% if editable %}
                <span class="help-text">Click +1 to allocate a point to a skill.</span>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <table class="skills-table" id="{{ component_id|default:'cs' }}-skills-list">
            <thead>
                <tr>
                    <th>Skill</th>
                    <th>Level</th>
                    <th>Points</th>
                    <th>Acquired</th>
                    {% if editable and free_skill_points > 0 %}<th></th>{% endif %}
                </tr>
            </thead>
            <tbody>
            {% for skill in skills %}
                <tr data-skill-name="{{ skill.name|default:skill }}">
                    <td class="skill-name-cell">
                        {% if editable %}
                        <span class="skill-name editable" onclick="CharacterSheet.startRenameSkill('{{ component_id|default:'cs' }}', this)" title="Click to rename">{{ skill.display_name|default:skill }}</span>
                        {% else %}
                        <span class="skill-name">{{ skill.display_name|default:skill }}</span>
                        {% endif %}
                    </td>
                    <td class="skill-level-cell">{{ skill.level_roman|default:"-" }}</td>
                    <td class="skill-points-cell">{% if skill.excess_points %}+{{ skill.excess_points }}{% else %}-{% endif %}</td>
                    <td class="skill-acquired-cell">{{ skill.acquired|default:"Automatic" }}</td>
                    {% if editable and free_skill_points > 0 %}
                    <td class="skill-action-cell">
                        <button type="button" class="btn-allocate" onclick="CharacterSheet.allocatePoint('{{ component_id|default:'cs' }}', '{{ skill.name|default:skill }}')" title="Allocate 1 free point">+1</button>
                    </td>
                    {% endif %}
                </tr>
            {% empty %}
                <tr><td colspan="4" class="no-skills-msg"><em>No skills yet</em></td></tr>
            {% endfor %}
            </tbody>
        </table>

        {% if editable %}
        <div class="add-skill-row">
            <input type="text" id="{{ component_id|default:'cs' }}-new-skill" placeholder="Add skill (e.g., Tracking)"
                   onkeypress="if(event.key==='Enter'){CharacterSheet.addSkill('{{ component_id|default:'cs' }}');return false;}">
            <button type="button" class="btn-add" onclick="CharacterSheet.addSkill('{{ component_id|default:'cs' }}')">+ Add{% if free_skill_points > 0 %} (uses 1 free point){% endif %}</button>
        </div>
        {% endif %}
    </div>

    {% if char_data.skill_track %}
    <!-- Skill Track Section -->
    <div class="sheet-section">
        <h2>Skill Track</h2>
        <div class="field-row">
            <label>Track:</label>
            <span class="field-value">{{ char_data.skill_track.track }}</span>
        </div>
        <div class="field-row">
            <label>Survivability:</label>
            <span class="field-value">{{ char_data.skill_track.survivability }}+</span>
        </div>
        {% if char_data.skill_track.craft_type %}
        <div class="field-row">
            <label>Craft:</label>
            <span class="field-value">{{ char_data.skill_track.craft_type }}</span>
        </div>
        {% endif %}
        {% if char_data.skill_track.magic_school %}
        <div class="field-row">
            <label>Magic School:</label>
            <span class="field-value">{{ char_data.skill_track.magic_school }}</span>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Movement & Encumbrance Section -->
    <div class="sheet-section movement-section">
        <h2>Movement & Encumbrance</h2>

        <div class="movement-stats">
            <div class="stat-block">
                <label>Base MA</label>
                <span class="stat-value" data-computed="base_ma">{{ base_ma|default:8 }}</span>
                <span class="stat-formula">(DEX − 2, min 4)</span>
            </div>
            <div class="stat-block">
                <label>Fatigue Pool</label>
                <span class="stat-value" data-computed="fatigue_pool">{{ char_data.attributes.STR|default:10 }}</span>
                <span class="stat-formula">(= STR)</span>
            </div>
        </div>

        <h3>Encumbrance Thresholds (<span id="{{ component_id|default:'cs' }}-enc-str-label">STR {{ char_data.attributes.STR|default:10 }}</span>)</h3>
        <table class="reference-table encumbrance-table" id="{{ component_id|default:'cs' }}-enc-thresholds">
            <thead>
                <tr>
                    <th>Load Level</th>
                    <th>Weight (lbs)</th>
                    <th>MA Mod</th>
                    <th>Restrictions</th>
                </tr>
            </thead>
            <tbody>
                <tr class="enc-unencumbered">
                    <td>Unencumbered</td>
                    <td>0–<span data-threshold="unenc-max">{{ enc_unenc_max|default:10 }}</span></td>
                    <td>0</td>
                    <td>—</td>
                </tr>
                <tr class="enc-light">
                    <td>Light</td>
                    <td><span data-threshold="light-min">{{ enc_light_min|default:11 }}</span>–<span data-threshold="light-max">{{ enc_light_max|default:15 }}</span></td>
                    <td>−1</td>
                    <td>—</td>
                </tr>
                <tr class="enc-medium">
                    <td>Medium</td>
                    <td><span data-threshold="med-min">{{ enc_med_min|default:16 }}</span>–<span data-threshold="med-max">{{ enc_med_max|default:20 }}</span></td>
                    <td>−2</td>
                    <td>Cannot Run</td>
                </tr>
                <tr class="enc-heavy">
                    <td>Heavy</td>
                    <td><span data-threshold="heavy-min">{{ enc_heavy_min|default:21 }}</span>–<span data-threshold="heavy-max">{{ enc_heavy_max|default:25 }}</span></td>
                    <td>−4</td>
                    <td>Cannot Run/Jog</td>
                </tr>
                <tr class="enc-overloaded">
                    <td>Overloaded</td>
                    <td>&gt;<span data-threshold="overload-min">{{ enc_heavy_max|default:25 }}</span></td>
                    <td>Walk only</td>
                    <td>1 hex max</td>
                </tr>
            </tbody>
        </table>

        <h3>Movement Speeds</h3>
        <table class="reference-table" id="{{ component_id|default:'cs' }}-movement-table">
            <thead>
                <tr>
                    <th>Speed</th>
                    <th>Hexes</th>
                    <th>Fatigue</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr data-speed="run">
                    <td><strong>Run</strong></td>
                    <td class="hex-value" data-base-multiplier="1"><span class="current-hexes">{{ base_ma|default:8 }}</span></td>
                    <td>1/turn</td>
                    <td>None</td>
                </tr>
                <tr data-speed="jog">
                    <td><strong>Jog</strong></td>
                    <td class="hex-value" data-base-multiplier="0.5"><span class="current-hexes">{{ jog_hexes|default:4 }}</span></td>
                    <td>1/4 turns</td>
                    <td>Charge, Dodge, Drop</td>
                </tr>
                <tr data-speed="walk">
                    <td><strong>Walk</strong></td>
                    <td class="hex-value">≤2</td>
                    <td>None</td>
                    <td>Ready Weapon</td>
                </tr>
                <tr data-speed="walk-slow">
                    <td><strong>Walk (slow)</strong></td>
                    <td class="hex-value">≤1</td>
                    <td>None</td>
                    <td>Cast, Missile, Disbelieve</td>
                </tr>
                <tr data-speed="stand">
                    <td><strong>Stand Still</strong></td>
                    <td class="hex-value">0</td>
                    <td>None</td>
                    <td>Stand Up, Pick Up</td>
                </tr>
            </tbody>
        </table>

        <div class="movement-notes">
            <p><strong>Engaged:</strong> Can only Shift (1 hex, stay adjacent) or Stand Still.</p>
            <p><strong>Exhausted (fatigue = ST):</strong> MA halved, −2 DX, cannot Run.</p>
        </div>
    </div>

    <!-- Equipment & Encumbrance Section -->
    <div class="sheet-section equipment-section" id="{{ component_id|default:'cs' }}-equipment">
        <h2>Equipment & Encumbrance</h2>

        <div class="encumbrance-status" id="{{ component_id|default:'cs' }}-enc-status">
            <div class="enc-summary">
                <div class="enc-stat">
                    <label>Total Weight Carried</label>
                    <span class="enc-value" id="{{ component_id|default:'cs' }}-total-weight">0</span>
                    <span class="enc-unit">lbs</span>
                </div>
                <div class="enc-stat">
                    <label>Pack Weight</label>
                    <span class="enc-value" id="{{ component_id|default:'cs' }}-pack-weight">0</span>
                    <span class="enc-unit">lbs</span>
                </div>
                <div class="enc-stat">
                    <label>Load Level</label>
                    <span class="enc-level" id="{{ component_id|default:'cs' }}-load-level">Unencumbered</span>
                </div>
                <div class="enc-stat">
                    <label>MA Modifier</label>
                    <span class="enc-mod" id="{{ component_id|default:'cs' }}-ma-mod">0</span>
                </div>
                <div class="enc-stat">
                    <label>Effective MA</label>
                    <span class="enc-value" id="{{ component_id|default:'cs' }}-effective-ma">{{ base_ma|default:8 }}</span>
                </div>
            </div>

            <div class="pack-controls">
                <label class="pack-toggle">
                    <input type="checkbox" id="{{ component_id|default:'cs' }}-pack-dropped" onchange="EncumbranceCalc.togglePack('{{ component_id|default:'cs' }}')">
                    Pack Dropped (free action at start of movement)
                </label>
            </div>
        </div>

        <!-- Weapons -->
        <h3>Weapons</h3>
        <div class="equipment-category" id="{{ component_id|default:'cs' }}-weapons">
            <table class="equipment-table weapons-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Hit</th>
                        <th>Crit</th>
                        <th>Dmg</th>
                        <th>Wt</th>
                        <th>Value</th>
                        <th>Eq</th>
                        <th>Pack</th>
                        <th>Notes</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="{{ component_id|default:'cs' }}-weapons-tbody">
                </tbody>
                <tfoot id="{{ component_id|default:'cs' }}-weapons-tfoot">
                    <tr class="total-row">
                        <td colspan="5" style="text-align:right;font-weight:bold;">Total:</td>
                        <td id="{{ component_id|default:'cs' }}-weapons-total-weight">0</td>
                        <td colspan="5"></td>
                    </tr>
                </tfoot>
            </table>
            <div class="add-item-row">
                <button type="button" class="btn-add-item" onclick="EncumbranceCalc.showAddForm('{{ component_id|default:'cs' }}', 'weapon')">+ Add Weapon</button>
            </div>
        </div>

        <!-- Armour -->
        <h3>Armour</h3>
        <div class="equipment-category" id="{{ component_id|default:'cs' }}-armour">
            <table class="equipment-table armour-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Absorb</th>
                        <th>Wt</th>
                        <th>Value</th>
                        <th>Eq</th>
                        <th>Pack</th>
                        <th>Notes</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="{{ component_id|default:'cs' }}-armour-tbody">
                </tbody>
                <tfoot id="{{ component_id|default:'cs' }}-armour-tfoot">
                    <tr class="total-row">
                        <td colspan="3" style="text-align:right;font-weight:bold;">Total:</td>
                        <td id="{{ component_id|default:'cs' }}-armour-total-weight">0</td>
                        <td colspan="5"></td>
                    </tr>
                </tfoot>
            </table>
            <div class="add-item-row">
                <button type="button" class="btn-add-item" onclick="EncumbranceCalc.showAddForm('{{ component_id|default:'cs' }}', 'armour')">+ Add Armour</button>
            </div>
        </div>

        <!-- Misc Equipment -->
        <h3>Miscellaneous</h3>
        <div class="equipment-category" id="{{ component_id|default:'cs' }}-misc">
            <table class="equipment-table misc-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Attr Mod</th>
                        <th>Wt</th>
                        <th>Value</th>
                        <th>Eq</th>
                        <th>Pack</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="{{ component_id|default:'cs' }}-misc-tbody">
                </tbody>
                <tfoot id="{{ component_id|default:'cs' }}-misc-tfoot">
                    <tr class="total-row">
                        <td colspan="3" style="text-align:right;font-weight:bold;">Total:</td>
                        <td id="{{ component_id|default:'cs' }}-misc-total-weight">0</td>
                        <td colspan="4"></td>
                    </tr>
                </tfoot>
            </table>
            <div class="add-item-row">
                <button type="button" class="btn-add-item" onclick="EncumbranceCalc.showAddForm('{{ component_id|default:'cs' }}', 'misc')">+ Add Item</button>
            </div>
        </div>

        <!-- Add Item Modal/Form -->
        <div class="add-item-modal" id="{{ component_id|default:'cs' }}-add-modal" style="display: none;">
            <div class="modal-content">
                <h4 id="{{ component_id|default:'cs' }}-modal-title">Add Item</h4>
                <input type="hidden" id="{{ component_id|default:'cs' }}-item-category">

                <div class="modal-fields">
                    <div class="field-group">
                        <label>Name</label>
                        <input type="text" id="{{ component_id|default:'cs' }}-item-name" placeholder="Item name">
                    </div>
                    <div class="field-group">
                        <label>Description</label>
                        <input type="text" id="{{ component_id|default:'cs' }}-item-desc" placeholder="Brief description">
                    </div>

                    <!-- Weapon-specific fields -->
                    <div class="weapon-fields" style="display: none;">
                        <div class="field-group inline">
                            <label>Hit Mod</label>
                            <input type="text" id="{{ component_id|default:'cs' }}-item-hit" placeholder="+0" class="small-input">
                        </div>
                        <div class="field-group inline">
                            <label>Crit Mod</label>
                            <input type="text" id="{{ component_id|default:'cs' }}-item-crit" placeholder="+0" class="small-input">
                        </div>
                        <div class="field-group inline">
                            <label>Dmg Mod</label>
                            <input type="text" id="{{ component_id|default:'cs' }}-item-dmg" placeholder="+0" class="small-input">
                        </div>
                    </div>

                    <!-- Armour-specific fields -->
                    <div class="armour-fields" style="display: none;">
                        <div class="field-group inline">
                            <label>Damage Absorbed</label>
                            <input type="number" id="{{ component_id|default:'cs' }}-item-absorb" placeholder="0" class="small-input" min="0">
                        </div>
                    </div>

                    <!-- Misc-specific fields -->
                    <div class="misc-fields" style="display: none;">
                        <div class="field-group inline">
                            <label>Attribute Modified</label>
                            <input type="text" id="{{ component_id|default:'cs' }}-item-attrmod" placeholder="e.g., +1 INT" class="small-input">
                        </div>
                    </div>

                    <!-- Common fields -->
                    <div class="field-group inline">
                        <label>Weight (lbs)</label>
                        <input type="number" id="{{ component_id|default:'cs' }}-item-weight" placeholder="0" class="small-input" min="0" step="0.5">
                    </div>
                    <div class="field-group inline">
                        <label>Value</label>
                        <input type="text" id="{{ component_id|default:'cs' }}-item-value" placeholder="e.g., 10gp" class="small-input">
                    </div>
                    <div class="field-group inline">
                        <label><input type="checkbox" id="{{ component_id|default:'cs' }}-item-equipped"> Equipped</label>
                    </div>
                    <div class="field-group inline pack-field" style="display: none;">
                        <label><input type="checkbox" id="{{ component_id|default:'cs' }}-item-inpack"> In Pack</label>
                    </div>

                    <!-- Notes for weapon/armour -->
                    <div class="notes-field" style="display: none;">
                        <div class="field-group">
                            <label>Notes</label>
                            <input type="text" id="{{ component_id|default:'cs' }}-item-notes" placeholder="Other notes">
                        </div>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="EncumbranceCalc.hideAddForm('{{ component_id|default:'cs' }}')">Cancel</button>
                    <button type="button" class="btn-save" onclick="EncumbranceCalc.saveItem('{{ component_id|default:'cs' }}')">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Section -->
    <div class="sheet-section">
        <h2>Notes</h2>
        {% if editable %}
        <textarea class="notes-area" data-field="notes" placeholder="Character backstory, notes, etc...">{{ char_data.notes|default:"" }}</textarea>
        {% else %}
        <div class="notes-display">{{ char_data.notes|default:"No notes"|linebreaks }}</div>
        {% endif %}
    </div>

    {% if char_data.generation_log or yearly_results %}
    <!-- Combined Character Log Section -->
    <div class="sheet-section character-log-section">
        <h2>Character Log</h2>

        {% if show_experience and yearly_results %}
        <!-- Prior Experience Summary -->
        <div class="experience-summary">
            <div class="summary-row">
                <span class="summary-label">Prior Experience:</span>
                <span class="summary-value">{{ years_served|default:0 }} years as {{ track_name|default:"Unknown" }}</span>
                <span class="summary-ages">(Age 16 → {{ current_age|default:16 }})</span>
                {% if died %}
                <span class="died-badge">DECEASED</span>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if char_data.generation_log %}
        <!-- Character Generation Rolls -->
        <h3>Character Generation</h3>
        <div class="generation-log">
            {% regroup char_data.generation_log by type as log_by_type %}
            {% for type_group in log_by_type %}
            <div class="log-group">
                <h4>{{ type_group.grouper|title }}</h4>
                <ul class="log-entries">
                    {% for entry in type_group.list %}
                    <li class="log-entry">
                        <span class="log-name">{{ entry.name }}:</span>
                        <span class="log-rolls">
                            {% for roll in entry.rolls %}{{ roll }}{% if not forloop.last %}, {% endif %}{% endfor %}
                        </span>
                        <span class="log-arrow">&rarr;</span>
                        <span class="log-result">{{ entry.result }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if show_experience and yearly_results %}
        <!-- Year-by-Year Experience Log -->
        <h3>Prior Experience Log</h3>
        <div class="experience-log">
            {% for yr in yearly_results %}
            <div class="year-entry {% if not yr.survived %}died{% endif %}">
                <strong>Year {{ yr.year }}:</strong> {{ yr.skill }} |
                Survival: {{ yr.surv_roll }}{% if yr.surv_mod >= 0 %}+{% endif %}{{ yr.surv_mod }}={{ yr.surv_total }} vs {{ yr.surv_target }}+
                [{% if yr.survived %}<span class="survived">Survived</span>{% else %}<span class="died-text">DIED</span>{% endif %}]
                {% if yr.aging %}
                    {% for attr, penalty in yr.aging.items %}
                        {% if penalty %}| <span class="aging-penalty">{{ attr|upper }} {{ penalty }}</span>{% endif %}
                    {% endfor %}
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<style>
/* Character Sheet Component Styles */
.character-sheet-component {
    max-width: 800px;
}

.sheet-section {
    margin-bottom: 20px;
    padding: 15px;
    border: 1px solid #ccc;
    background: #fafafa;
}

.sheet-section h2 {
    margin: 0 0 15px 0;
    font-size: 1.2em;
    border-bottom: 1px solid #999;
    padding-bottom: 8px;
}

.sheet-section h3 {
    margin: 15px 0 10px 0;
    font-size: 1em;
}

.section-help {
    font-size: 0.85em;
    color: #666;
    margin-bottom: 15px;
}

/* Attributes grid */
.attributes-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
}

.attr-box {
    border: 1px solid #ddd;
    padding: 10px;
    background: #fff;
    text-align: center;
}

.attr-box label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    font-size: 0.9em;
}

.attr-box .attr-input {
    width: 60px;
    text-align: center;
    font-size: 18px;
    font-weight: bold;
    padding: 4px;
    border: 1px solid #ccc;
}

.attr-box .attr-value {
    display: block;
    font-size: 18px;
    font-weight: bold;
}

.attr-box .attr-input.invalid {
    border-color: #c44;
    background: #fee;
}

.attr-box .modifier {
    display: block;
    margin-top: 5px;
    font-size: 0.85em;
    color: #666;
}

.attr-box .attr-values {
    display: flex;
    align-items: baseline;
    flex-wrap: wrap;
    gap: 4px;
}

.attr-box .adjusted-attr {
    color: #2196f3;
    font-weight: 500;
}

.attr-box .adjusted-attr .adjusted-value {
    color: #1976d2;
    font-weight: 600;
}

.attr-box .adjusted-attr .adj-mod {
    font-size: 0.85em;
    color: #64b5f6;
}

/* Derived stats */
.derived-stats {
    display: flex;
    gap: 30px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px dashed #ccc;
}

.derived-stat {
    text-align: center;
}

.derived-stat label {
    display: block;
    font-weight: bold;
    font-size: 0.9em;
}

.derived-stat .value {
    font-size: 20px;
    color: #333;
}

/* Field rows */
.field-row {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    gap: 10px;
}

.field-row label {
    width: 120px;
    font-weight: bold;
    flex-shrink: 0;
}

.field-row input[type="text"],
.field-row select {
    flex: 1;
    max-width: 300px;
    padding: 6px 8px;
    font-family: monospace;
    font-size: 14px;
    border: 1px solid #ccc;
    background: #fff;
}

.field-row .field-value {
    padding: 4px 0;
}

/* Skills table */
.skills-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9em;
    margin-bottom: 10px;
}

.skills-table th {
    background: #f5f5f5;
    border: 1px solid #ddd;
    padding: 8px 12px;
    text-align: left;
    font-weight: 600;
}

.skills-table td {
    border: 1px solid #ddd;
    padding: 6px 12px;
}

.skills-table tbody tr:nth-child(even) {
    background: #fafafa;
}

.skills-table tbody tr:hover {
    background: #f0f7ff;
}

.skill-name-cell {
    min-width: 120px;
}

.skill-name.editable {
    cursor: pointer;
    padding: 2px 4px;
}

.skill-name.editable:hover {
    background: #eef;
    outline: 1px dashed #99c;
}

.skill-level-cell,
.skill-points-cell,
.skill-acquired-cell {
    text-align: center;
    white-space: nowrap;
}

.skill-action-cell {
    text-align: center;
    padding: 4px;
}

.skill-rename-input {
    font-family: inherit;
    font-size: 0.9em;
    padding: 4px 8px;
    border: 1px solid #666;
    background: #fff;
    min-width: 100px;
}

.no-skills-msg {
    color: #666;
    font-style: italic;
    text-align: center;
}

.add-skill-row {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px dashed #ccc;
}

.add-skill-row input {
    flex: 1;
    padding: 8px;
    font-family: monospace;
    font-size: 14px;
    border: 1px solid #ccc;
}

.add-skill-row .btn-add {
    padding: 8px 15px;
    background: #4a4;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 14px;
}

.add-skill-row .btn-add:hover {
    background: #3a3;
}

/* Skill points info */
.skill-points-info {
    margin-bottom: 15px;
    padding: 10px;
    background: #fff;
    border: 1px solid #ddd;
}

.xp-display {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
}

.xp-display label {
    font-weight: bold;
}

.xp-value {
    font-size: 1.1em;
    color: #333;
}

.free-points-banner {
    background: #e8f5e9;
    border: 2px solid #4caf50;
    padding: 10px 15px;
    border-radius: 4px;
    color: #2e7d32;
}

.free-points-banner .help-text {
    display: block;
    font-size: 0.85em;
    font-weight: normal;
    margin-top: 5px;
    color: #558b2f;
}

.free-points-display {
    display: flex;
    align-items: center;
    gap: 10px;
}

.free-points-display label {
    font-weight: bold;
}

/* Skill allocation button */
.skill-item {
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.btn-allocate {
    background: #4caf50;
    color: white;
    border: none;
    padding: 2px 8px;
    font-size: 0.8em;
    cursor: pointer;
    border-radius: 3px;
    font-weight: bold;
}

.btn-allocate:hover {
    background: #388e3c;
}

/* Experience section */
.experience-summary {
    margin-bottom: 15px;
}

.experience-log {
    font-size: 0.9em;
    background: #fff;
    padding: 10px;
    border: 1px solid #ddd;
    max-height: 250px;
    overflow-y: auto;
}

.year-entry {
    padding: 5px 0;
    border-bottom: 1px dotted #ddd;
}

.year-entry:last-child {
    border-bottom: none;
}

.year-entry.died {
    background: #fee;
}

.died-notice, .died-text {
    color: #c44;
    font-weight: bold;
}

.survived {
    color: #4a4;
}

.aging-penalty {
    color: #c60;
    font-style: italic;
    font-size: 0.85em;
    display: block;
    margin-top: 2px;
}

/* Combined Character Log Section */
.character-log-section {
    background: #f8f9fa;
}

.character-log-section h3 {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
}

.character-log-section h3:first-of-type {
    margin-top: 10px;
    padding-top: 0;
    border-top: none;
}

.character-log-section h4 {
    font-size: 0.9em;
    color: #666;
    margin: 8px 0 4px 0;
}

.character-log-section .experience-summary {
    background: #eef;
    padding: 10px 15px;
    border-radius: 4px;
    margin-bottom: 10px;
}

.character-log-section .summary-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
}

.character-log-section .summary-label {
    font-weight: 600;
}

.character-log-section .summary-value {
    color: #2a6496;
}

.character-log-section .summary-ages {
    color: #666;
    font-size: 0.9em;
}

.character-log-section .died-badge {
    background: #c44;
    color: white;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 0.8em;
    font-weight: bold;
}

/* Legacy class for backwards compat */
.generation-log-section {
    background: #fafafa;
}

.generation-log {
    font-size: 0.9em;
}

.generation-log .log-group {
    margin-bottom: 12px;
}

.generation-log .log-group h3 {
    font-size: 0.95em;
    color: #555;
    margin: 0 0 6px 0;
    padding-bottom: 3px;
    border-bottom: 1px solid #ddd;
}

.generation-log .log-entries {
    list-style: none;
    margin: 0;
    padding: 0 0 0 10px;
}

.generation-log .log-entry {
    padding: 3px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: baseline;
}

.generation-log .log-name {
    font-weight: 600;
    color: #333;
    min-width: 80px;
}

.generation-log .log-rolls {
    color: #666;
    font-family: monospace;
    background: #eee;
    padding: 1px 5px;
    border-radius: 3px;
}

.generation-log .log-arrow {
    color: #999;
}

.generation-log .log-result {
    color: #2a6496;
    font-weight: 500;
}

/* Notes */
.notes-area {
    width: 100%;
    min-height: 100px;
    font-family: monospace;
    font-size: 14px;
    padding: 10px;
    border: 1px solid #ccc;
    resize: vertical;
    box-sizing: border-box;
}

.notes-display {
    background: #fff;
    padding: 10px;
    border: 1px solid #ddd;
    min-height: 60px;
}

/* Movement & Encumbrance section */
.movement-section h3 {
    margin-top: 15px;
    margin-bottom: 8px;
    font-size: 0.95em;
    border-bottom: 1px dashed #ccc;
    padding-bottom: 4px;
}

.movement-stats {
    display: flex;
    gap: 30px;
    margin-bottom: 15px;
}

.stat-block {
    text-align: center;
    padding: 10px 20px;
    background: #fff;
    border: 1px solid #ddd;
}

.stat-block label {
    display: block;
    font-weight: bold;
    font-size: 0.9em;
    margin-bottom: 5px;
}

.stat-block .stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #333;
}

.stat-block .stat-formula {
    display: block;
    font-size: 0.75em;
    color: #888;
    margin-top: 3px;
}

/* Reference tables */
.reference-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85em;
    margin-bottom: 15px;
}

.reference-table th,
.reference-table td {
    border: 1px solid #ccc;
    padding: 6px 8px;
    text-align: left;
}

.reference-table th {
    background: #eee;
    font-weight: bold;
}

.reference-table tbody tr:nth-child(even) {
    background: #f9f9f9;
}

/* Encumbrance level colors */
.enc-unencumbered { background: #e8f5e9 !important; }
.enc-light { background: #fff9c4 !important; }
.enc-medium { background: #ffe0b2 !important; }
.enc-heavy { background: #ffccbc !important; }
.enc-overloaded { background: #ffcdd2 !important; }

.movement-notes {
    font-size: 0.85em;
    color: #555;
    background: #f5f5f5;
    padding: 10px;
    border: 1px solid #ddd;
}

.movement-notes p {
    margin: 0 0 5px 0;
}

.movement-notes p:last-child {
    margin-bottom: 0;
}

/* Equipment & Encumbrance section */
.equipment-section h3 {
    margin-top: 15px;
    margin-bottom: 8px;
    font-size: 0.95em;
    border-bottom: 1px dashed #ccc;
    padding-bottom: 4px;
}

.encumbrance-status {
    background: #fff;
    border: 1px solid #ddd;
    padding: 15px;
    margin-bottom: 15px;
}

.enc-summary {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 10px;
}

.enc-stat {
    text-align: center;
    padding: 8px 12px;
    background: #f5f5f5;
    border: 1px solid #ddd;
    min-width: 70px;
}

.enc-stat label {
    display: block;
    font-size: 0.7em;
    color: #666;
    margin-bottom: 3px;
}

.enc-stat .enc-value,
.enc-stat .enc-level,
.enc-stat .enc-mod {
    font-size: 1.1em;
    font-weight: bold;
}

.enc-stat .enc-unit {
    font-size: 0.8em;
    color: #888;
}

/* Encumbrance level status colors */
.enc-stat .enc-level.level-unencumbered { color: #2e7d32; }
.enc-stat .enc-level.level-light { color: #f9a825; }
.enc-stat .enc-level.level-medium { color: #ef6c00; }
.enc-stat .enc-level.level-heavy { color: #d84315; }
.enc-stat .enc-level.level-overloaded { color: #c62828; }

.pack-controls {
    padding-top: 10px;
    border-top: 1px dashed #ddd;
}

.pack-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 0.9em;
}

.pack-toggle input[type="checkbox"] {
    width: 18px;
    height: 18px;
}

.pack-dropped-notice {
    color: #1565c0;
    font-weight: bold;
    margin-left: 10px;
}

/* Equipment categories */
.equipment-category {
    margin-bottom: 15px;
}

/* Equipment tables */
.equipment-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8em;
    margin-bottom: 5px;
}

.equipment-table th,
.equipment-table td {
    border: 1px solid #ccc;
    padding: 4px 6px;
    text-align: left;
}

.equipment-table th {
    background: #eee;
    font-weight: bold;
    font-size: 0.85em;
}

.equipment-table tbody tr:nth-child(even) {
    background: #f9f9f9;
}

.equipment-table tbody tr.in-pack-item {
    opacity: 0.5;
}

.equipment-table tbody tr.in-pack-item td {
    text-decoration: line-through;
}

.equipment-table tbody tr.not-equipped {
    color: #888;
}

.equipment-table tfoot .total-row {
    background: #f0f0f0;
    font-weight: bold;
}

.equipment-table tfoot .total-row td {
    padding: 6px 8px;
    border-top: 2px solid #999;
}

.equipment-table .btn-remove {
    background: #c44;
    color: white;
    border: none;
    padding: 2px 6px;
    cursor: pointer;
    font-size: 0.8em;
}

.equipment-table .btn-remove:hover {
    background: #a33;
}

.equipment-table .equipped-toggle,
.equipment-table .pack-toggle-cell {
    text-align: center;
}

.equipment-table input[type="checkbox"] {
    cursor: pointer;
}

/* Compact column widths */
.weapons-table th:nth-child(3),
.weapons-table th:nth-child(4),
.weapons-table th:nth-child(5),
.armour-table th:nth-child(3) {
    width: 40px;
    text-align: center;
}

.equipment-table th:last-child {
    width: 30px;
}

/* Add item button */
.add-item-row {
    margin-top: 5px;
}

.btn-add-item {
    padding: 4px 12px;
    background: #4a4;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 0.85em;
}

.btn-add-item:hover {
    background: #3a3;
}

/* Add Item Modal */
.add-item-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.add-item-modal .modal-content {
    background: white;
    padding: 20px;
    border-radius: 4px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.add-item-modal h4 {
    margin: 0 0 15px 0;
    padding-bottom: 10px;
    border-bottom: 1px solid #ccc;
}

.modal-fields {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.modal-fields .field-group {
    flex: 1 1 100%;
}

.modal-fields .field-group.inline {
    flex: 0 0 auto;
    min-width: 80px;
}

.modal-fields .field-group label {
    display: block;
    font-size: 0.85em;
    font-weight: bold;
    margin-bottom: 3px;
}

.modal-fields .field-group input[type="text"],
.modal-fields .field-group input[type="number"] {
    width: 100%;
    padding: 6px 8px;
    font-family: monospace;
    font-size: 14px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}

.modal-fields .field-group .small-input {
    width: 80px;
}

.modal-fields .weapon-fields,
.modal-fields .armour-fields,
.modal-fields .misc-fields {
    display: flex;
    gap: 10px;
    flex: 1 1 100%;
}

.modal-buttons {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #ccc;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.modal-buttons .btn-cancel {
    padding: 8px 16px;
    background: #888;
    color: white;
    border: none;
    cursor: pointer;
}

.modal-buttons .btn-cancel:hover {
    background: #666;
}

.modal-buttons .btn-save {
    padding: 8px 16px;
    background: #4a4;
    color: white;
    border: none;
    cursor: pointer;
}

.modal-buttons .btn-save:hover {
    background: #3a3;
}

/* Save status indicators */
.attr-input.saving, input.saving, select.saving, textarea.saving {
    background: #ffc !important;
}

.attr-input.saved, input.saved, select.saved, textarea.saved {
    background: #cfc !important;
}

.attr-input.error, input.error, select.error, textarea.error {
    background: #fcc !important;
}

/* Mobile responsive */
@media screen and (max-width: 768px) {
    .attributes-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .field-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }

    .field-row label {
        width: auto;
    }

    .field-row input[type="text"],
    .field-row select {
        width: 100%;
        max-width: none;
        padding: 10px 8px;
        font-size: 16px;
        box-sizing: border-box;
    }

    .derived-stats {
        flex-wrap: wrap;
        gap: 15px;
    }

    .add-skill-row {
        flex-direction: column;
    }

    .add-skill-row input,
    .add-skill-row .btn-add {
        width: 100%;
        box-sizing: border-box;
    }
}

@media screen and (max-width: 480px) {
    .attributes-grid {
        grid-template-columns: 1fr;
    }

    .attr-box {
        display: flex;
        align-items: center;
        justify-content: space-between;
        text-align: left;
    }

    .attr-box label {
        margin-bottom: 0;
        margin-right: 10px;
    }

    .attr-box .modifier {
        margin-top: 0;
        margin-left: 10px;
    }
}
</style>

{% if editable %}
<script>
/**
 * CharacterSheet - Reusable character sheet editing functionality
 */
var CharacterSheet = (function() {
    var saveTimeouts = {};
    var SAVE_DELAY = 300;

    /**
     * Parse attribute value from display format.
     */
    function parseAttributeValue(str) {
        str = str.trim();

        // Check for decimal notation (e.g., 18.10, 19.50)
        var decimalMatch = str.match(/^(\d+)\.(\d+)$/);
        if (decimalMatch) {
            var base = parseInt(decimalMatch[1], 10);
            var sub = parseInt(decimalMatch[2], 10);
            if (base >= 18 && sub >= 10 && sub <= 100 && sub % 10 === 0) {
                return { valid: true, value: str };
            }
            return { valid: false, value: str };
        }

        // Check for plain integer
        var intMatch = str.match(/^(\d+)$/);
        if (intMatch) {
            var val = parseInt(intMatch[1], 10);
            if (val >= 1) {
                return { valid: true, value: val };
            }
            return { valid: false, value: str };
        }

        return { valid: false, value: str };
    }

    function validateAttributeInput(element) {
        var result = parseAttributeValue(element.value);
        if (result.valid) {
            element.classList.remove('invalid');
        } else {
            element.classList.add('invalid');
        }
        return result;
    }

    function validateNumericField(element) {
        // Allow only numbers, spaces, periods, and height notation (' and ")
        var field = element.dataset.field;
        var allowedPattern = field === 'height' ? /[^0-9'"\s.]/g : /[^0-9\s.]/g;
        var cleaned = element.value.replace(allowedPattern, '');
        if (cleaned !== element.value) {
            element.value = cleaned;
        }
    }

    function showStatus(element, status) {
        element.classList.remove('saving', 'saved', 'error');
        if (status) {
            element.classList.add(status);
        }
    }

    function debounceSave(element, componentId) {
        showStatus(element, 'saving');

        var key = componentId + '-' + element.dataset.field;
        if (saveTimeouts[key]) {
            clearTimeout(saveTimeouts[key]);
        }

        saveTimeouts[key] = setTimeout(function() {
            saveField(element, componentId);
        }, SAVE_DELAY);
    }

    function saveField(element, componentId) {
        var container = document.getElementById(componentId + '-container');
        var saveUrl = container.dataset.saveUrl;
        var csrfToken = container.dataset.csrfToken;

        if (!saveUrl) {
            console.error('No save URL configured for component:', componentId);
            return;
        }

        var field = element.dataset.field;
        var value = element.value;

        // For attribute inputs, validate
        if (element.dataset.attr === 'true') {
            var result = parseAttributeValue(value);
            if (!result.valid) {
                showStatus(element, 'error');
                return;
            }
            value = result.value;
        }

        fetch(saveUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ field: field, value: value })
        })
        .then(function(response) { return response.json(); })
        .then(function(result) {
            if (result.success) {
                showStatus(element, 'saved');

                // Update computed fields
                if (result.computed) {
                    for (var key in result.computed) {
                        if (key === 'track_info') {
                            // Track availability changed - emit event for parent page
                            var event = new CustomEvent('trackInfoUpdated', {
                                detail: { trackInfo: result.computed.track_info }
                            });
                            document.dispatchEvent(event);
                            continue;
                        }
                        var el = container.querySelector('[data-computed="' + key + '"]');
                        if (el) {
                            if (key.endsWith('_mod') || key.endsWith('_adj_mod')) {
                                // Format modifiers with +/- prefix
                                var mod = result.computed[key];
                                el.textContent = '(' + (mod >= 0 ? '+' : '') + mod + ')';
                            } else {
                                el.textContent = result.computed[key];
                            }
                        }
                    }

                }

                // Always recalculate encumbrance after any attribute save
                // Use setTimeout to ensure DOM updates have been applied
                if (typeof EncumbranceCalc !== 'undefined') {
                    setTimeout(function() {
                        EncumbranceCalc.recalculate(componentId);
                    }, 10);
                }

                setTimeout(function() { showStatus(element, null); }, 2000);
            } else {
                showStatus(element, 'error');
            }
        })
        .catch(function(error) {
            console.error('Save error:', error);
            showStatus(element, 'error');
        });
    }

    function addSkill(componentId) {
        var container = document.getElementById(componentId + '-container');
        var input = document.getElementById(componentId + '-new-skill');
        var skill = input.value.trim();

        if (!skill) return;

        var saveUrl = container.dataset.saveUrl;
        var csrfToken = container.dataset.csrfToken;

        fetch(saveUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ field: 'skills', action: 'add', value: skill })
        })
        .then(function(response) { return response.json(); })
        .then(function(result) {
            if (result.success) {
                input.value = '';

                // Rebuild skills list if returned
                if (result.computed && result.computed.skills) {
                    rebuildSkillsList(componentId, result.computed.skills, result.computed.free_skill_points || 0);
                } else {
                    // Fallback: add to DOM directly
                    var list = document.getElementById(componentId + '-skills-list');
                    var noSkillsMsg = list.querySelector('.no-skills-msg');
                    if (noSkillsMsg) noSkillsMsg.remove();

                    var li = document.createElement('li');
                    li.className = 'skill-item';
                    li.innerHTML = '<span class="skill-tag">' + escapeHtml(skill) + '</span>';
                    list.appendChild(li);
                }
            }
        })
        .catch(function(error) {
            console.error('Add skill error:', error);
        });
    }

    function rebuildSkillsList(componentId, skills, freePoints) {
        var list = document.getElementById(componentId + '-skills-list');
        var container = document.getElementById(componentId + '-container');
        list.innerHTML = '';

        if (skills.length === 0) {
            var li = document.createElement('li');
            li.className = 'skill-item no-skills-msg';
            li.innerHTML = '<em>No skills yet</em>';
            list.appendChild(li);
            return;
        }

        skills.forEach(function(skill) {
            var li = document.createElement('li');
            li.className = 'skill-item';
            var skillName = skill.name || skill;
            var skillDisplay = skill.display || skill;
            li.dataset.skillName = skillName;
            // Add editable class and click handler for renaming
            var html = '<span class="skill-tag editable" onclick="CharacterSheet.startRenameSkill(\'' + componentId + '\', this)" title="Click to rename">' + escapeHtml(skillDisplay) + '</span>';
            if (freePoints > 0) {
                html += ' <button type="button" class="btn-allocate" onclick="CharacterSheet.allocatePoint(\'' + componentId + '\', \'' + escapeHtml(skillName).replace(/'/g, "\\'") + '\')" title="Allocate 1 free point">+1</button>';
            }
            li.innerHTML = html;
            list.appendChild(li);
        });

        // Update free points display (always visible)
        var freePointsSpan = document.getElementById(componentId + '-free-points');
        if (freePointsSpan) {
            freePointsSpan.textContent = freePoints;
        }

        // Update banner if it exists
        var bannerSpan = document.getElementById(componentId + '-free-points-banner');
        if (bannerSpan) {
            bannerSpan.textContent = freePoints;
        }

        // Update add skill button text
        var addBtn = container.querySelector('.add-skill-row .btn-add');
        if (addBtn) {
            addBtn.textContent = freePoints > 0 ? '+ Add (uses 1 free point)' : '+ Add';
        }

        // Show/hide free points banner based on remaining points
        var infoSection = document.getElementById(componentId + '-skill-points-info');
        if (infoSection) {
            var banner = infoSection.querySelector('.free-points-banner');
            if (banner) {
                banner.style.display = freePoints > 0 ? 'block' : 'none';
            }
        }

        // Recalculate encumbrance in case Porter skill was added/changed
        if (typeof EncumbranceCalc !== 'undefined') {
            EncumbranceCalc.recalculate(componentId);
        }
    }

    function allocatePoint(componentId, skillName) {
        var container = document.getElementById(componentId + '-container');
        var saveUrl = container.dataset.saveUrl;
        var csrfToken = container.dataset.csrfToken;

        fetch(saveUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ field: 'skill_points', action: 'allocate', skill_name: skillName })
        })
        .then(function(response) { return response.json(); })
        .then(function(result) {
            if (result.success) {
                // Rebuild skills list with updated data
                if (result.computed && result.computed.skills) {
                    rebuildSkillsList(componentId, result.computed.skills, result.computed.free_skill_points || 0);
                }
            } else {
                console.error('Allocate point failed:', result.error);
            }
        })
        .catch(function(error) {
            console.error('Allocate point error:', error);
        });
    }

    function startRenameSkill(componentId, skillTagElement) {
        // Get the skill name from the parent li element
        var li = skillTagElement.closest('.skill-item');
        var skillName = li.dataset.skillName;
        var currentDisplay = skillTagElement.textContent;

        // Extract just the base name (remove roman numerals and excess points)
        // e.g., "Sword II (+1)" -> "Sword"
        var baseName = currentDisplay.replace(/\s+[IVX]+(\s+\(\+\d+\))?$/, '').trim();

        // Create input element
        var input = document.createElement('input');
        input.type = 'text';
        input.className = 'skill-rename-input';
        input.value = baseName;
        input.dataset.originalSkillName = skillName;
        input.dataset.componentId = componentId;

        // Replace the span with the input
        skillTagElement.style.display = 'none';
        li.insertBefore(input, skillTagElement);
        input.focus();
        input.select();

        // Handle blur and enter key
        input.addEventListener('blur', function() {
            finishRenameSkill(componentId, input, skillTagElement, li);
        });
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                input.blur();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                cancelRenameSkill(input, skillTagElement);
            }
        });
    }

    function cancelRenameSkill(input, skillTagElement) {
        input.remove();
        skillTagElement.style.display = '';
    }

    function finishRenameSkill(componentId, input, skillTagElement, li) {
        var newName = input.value.trim();
        var oldName = input.dataset.originalSkillName;

        if (!newName || newName === oldName) {
            // No change, just restore the span
            cancelRenameSkill(input, skillTagElement);
            return;
        }

        var container = document.getElementById(componentId + '-container');
        var saveUrl = container.dataset.saveUrl;
        var csrfToken = container.dataset.csrfToken;

        fetch(saveUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                field: 'skills',
                action: 'rename',
                old_name: oldName,
                new_name: newName
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(result) {
            if (result.success) {
                // Rebuild skills list with updated data
                if (result.computed && result.computed.skills) {
                    rebuildSkillsList(componentId, result.computed.skills, result.computed.free_skill_points || 0);
                }
            } else {
                console.error('Rename skill failed:', result.error);
                alert('Failed to rename skill: ' + result.error);
                cancelRenameSkill(input, skillTagElement);
            }
        })
        .catch(function(error) {
            console.error('Rename skill error:', error);
            cancelRenameSkill(input, skillTagElement);
        });
    }

    function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function init(componentId, saveUrl, csrfToken) {
        var container = document.getElementById(componentId + '-container');
        if (!container) return;

        // Store config on container element
        container.dataset.saveUrl = saveUrl;
        container.dataset.csrfToken = csrfToken;

        // Initialize all editable fields
        container.querySelectorAll('input[data-field], select[data-field], textarea[data-field]').forEach(function(input) {
            // For attribute inputs, select all text on focus for easy replacement
            if (input.dataset.attr === 'true') {
                input.addEventListener('focus', function() {
                    this.select();
                });
            }

            // For numeric fields (height, weight), strip non-numeric characters
            if (input.classList.contains('numeric-field')) {
                input.addEventListener('input', function() {
                    validateNumericField(this);
                });
            }

            input.addEventListener('input', function() {
                if (this.dataset.attr === 'true') {
                    validateAttributeInput(this);
                }
                debounceSave(this, componentId);
            });

            input.addEventListener('change', function() {
                // For selects, save immediately on change
                if (this.tagName === 'SELECT') {
                    saveField(this, componentId);
                }
            });

            input.addEventListener('blur', function() {
                // Clear timeout and save immediately
                var key = componentId + '-' + this.dataset.field;
                if (saveTimeouts[key]) {
                    clearTimeout(saveTimeouts[key]);
                    saveTimeouts[key] = null;
                }
                saveField(this, componentId);
            });
        });

        // Handle race dropdown with "other" option
        var raceSelect = container.querySelector('#char-race');
        var raceOtherInput = container.querySelector('#char-race-other');
        if (raceSelect && raceOtherInput) {
            // Check if we have a custom race value (not one of the standard options)
            var standardRaces = ['human', 'elf', 'dwarf', 'giant'];
            var currentRace = raceOtherInput.value.trim();
            if (currentRace && standardRaces.indexOf(currentRace) === -1) {
                // Custom race is stored - set dropdown to "other" and show input
                raceSelect.value = 'other';
                raceOtherInput.style.display = 'block';
            }

            // Show/hide "other" text input based on selection
            function updateRaceOtherVisibility() {
                if (raceSelect.value === 'other') {
                    raceOtherInput.style.display = 'block';
                    // If "other" is selected but input is empty, focus it
                    if (!raceOtherInput.value.trim()) {
                        raceOtherInput.focus();
                    }
                } else {
                    raceOtherInput.style.display = 'none';
                    // Clear the "other" input when a standard race is selected
                    if (raceSelect.value && raceSelect.value !== 'other') {
                        raceOtherInput.value = '';
                    }
                }
            }

            // Check initial state (in case "other" is pre-selected)
            updateRaceOtherVisibility();

            // Handle dropdown change
            raceSelect.addEventListener('change', function() {
                updateRaceOtherVisibility();
                if (this.value === 'other') {
                    // Don't save "other" - wait for user to type in the text field
                    return;
                } else if (this.value) {
                    // Save the standard race value immediately
                    saveField(this, componentId);
                }
            });

            // Handle "other" text input
            raceOtherInput.addEventListener('input', function() {
                debounceSave(this, componentId);
            });

            raceOtherInput.addEventListener('blur', function() {
                var key = componentId + '-' + this.dataset.field;
                if (saveTimeouts[key]) {
                    clearTimeout(saveTimeouts[key]);
                    saveTimeouts[key] = null;
                }
                saveField(this, componentId);
            });
        }
    }

    return {
        init: init,
        addSkill: addSkill,
        allocatePoint: allocatePoint,
        startRenameSkill: startRenameSkill,
        parseAttributeValue: parseAttributeValue
    };
})();

/**
 * EncumbranceCalc - Equipment and encumbrance tracking with categories
 */
var EncumbranceCalc = (function() {
    // Store equipment data per component: { weapons: [], armour: [], misc: [], packDropped: false }
    var equipmentData = {};

    function getDefaultData() {
        return { weapons: [], armour: [], misc: [], packDropped: false };
    }

    function getPorterBonus(componentId) {
        // Check for Porter skill in the skills list
        var container = document.getElementById(componentId + '-container');
        var skillsList = container.querySelector('.skills-list');
        if (!skillsList) return 0;

        var porterBonus = 0;
        var skillTags = skillsList.querySelectorAll('.skill-tag');
        skillTags.forEach(function(tag) {
            var skillText = tag.textContent.toLowerCase();
            // Match "Porter", "Porter 2", "Porter III", etc.
            var match = skillText.match(/porter\s*(\d+|i{1,3}|iv|v)?/i);
            if (match) {
                var level = 1;
                if (match[1]) {
                    var levelStr = match[1].toLowerCase();
                    if (levelStr === 'i') level = 1;
                    else if (levelStr === 'ii') level = 2;
                    else if (levelStr === 'iii') level = 3;
                    else if (levelStr === 'iv') level = 4;
                    else if (levelStr === 'v') level = 5;
                    else level = parseInt(levelStr) || 1;
                }
                porterBonus = level * 10; // 10 lbs per Porter level
            }
        });
        return porterBonus;
    }

    function getThresholds(componentId) {
        var container = document.getElementById(componentId + '-container');
        // Read STR directly from the input field (or span for non-editable)
        var strInput = container.querySelector('[data-field="attributes.STR"]');
        var strValue = 10;
        if (strInput) {
            strValue = parseInt(strInput.value) || 10;
        } else {
            // Fallback to fatigue_pool display if no input field
            var fatiguePoolEl = container.querySelector('[data-computed="fatigue_pool"]');
            if (fatiguePoolEl) {
                strValue = parseInt(fatiguePoolEl.textContent) || 10;
            }
        }
        var porterBonus = getPorterBonus(componentId);
        var effectiveStr = strValue + porterBonus;

        return {
            str: strValue,
            porterBonus: porterBonus,
            effectiveStr: effectiveStr,
            unencMax: effectiveStr,
            lightMax: Math.floor(effectiveStr * 1.5),
            medMax: effectiveStr * 2,
            heavyMax: Math.floor(effectiveStr * 2.5)
        };
    }

    function updateThresholdTable(componentId, thresholds) {
        var container = document.getElementById(componentId + '-container');

        // Update the STR label
        var strLabel = document.getElementById(componentId + '-enc-str-label');
        if (strLabel) {
            var labelText = 'STR ' + thresholds.str;
            if (thresholds.porterBonus > 0) {
                labelText += ' + Porter ' + (thresholds.porterBonus / 10);
            }
            strLabel.textContent = labelText;
        }

        // Update threshold values in the table
        var table = document.getElementById(componentId + '-enc-thresholds');
        if (!table) return;

        var updateSpan = function(attr, value) {
            var span = table.querySelector('[data-threshold="' + attr + '"]');
            if (span) span.textContent = value;
        };

        updateSpan('unenc-max', thresholds.unencMax);
        updateSpan('light-min', thresholds.unencMax + 1);
        updateSpan('light-max', thresholds.lightMax);
        updateSpan('med-min', thresholds.lightMax + 1);
        updateSpan('med-max', thresholds.medMax);
        updateSpan('heavy-min', thresholds.medMax + 1);
        updateSpan('heavy-max', thresholds.heavyMax);
        updateSpan('overload-min', thresholds.heavyMax);
    }

    function getBaseMA(componentId) {
        var container = document.getElementById(componentId + '-container');
        var maEl = container.querySelector('[data-computed="base_ma"]');
        return parseInt(maEl.textContent) || 8;
    }

    function getEncumbranceLevel(weight, thresholds) {
        if (weight <= thresholds.unencMax) return { level: 'Unencumbered', mod: 0, canRun: true, canJog: true };
        if (weight <= thresholds.lightMax) return { level: 'Light', mod: -1, canRun: true, canJog: true };
        if (weight <= thresholds.medMax) return { level: 'Medium', mod: -2, canRun: false, canJog: true };
        if (weight <= thresholds.heavyMax) return { level: 'Heavy', mod: -4, canRun: false, canJog: false };
        return { level: 'Overloaded', mod: 0, canRun: false, canJog: false, walkOnly: true };
    }

    function getAllItems(componentId) {
        var data = equipmentData[componentId] || getDefaultData();
        var allItems = [];
        ['weapons', 'armour', 'misc'].forEach(function(cat) {
            (data[cat] || []).forEach(function(item) {
                allItems.push(Object.assign({}, item, { category: cat }));
            });
        });
        return allItems;
    }

    function calculateEncumbrance(componentId) {
        var data = equipmentData[componentId] || getDefaultData();
        var thresholds = getThresholds(componentId);
        var baseMA = getBaseMA(componentId);

        // Update the threshold table to reflect current STR and Porter bonus
        updateThresholdTable(componentId, thresholds);

        var totalWeight = 0;
        var packWeight = 0;
        var allItems = getAllItems(componentId);

        allItems.forEach(function(item) {
            if (!item.equipped) return; // Only count equipped items
            var weight = parseFloat(item.weight) || 0;
            if (item.inPack) {
                packWeight += weight;
                if (!data.packDropped) {
                    totalWeight += weight;
                }
            } else {
                totalWeight += weight;
            }
        });

        var encLevel = getEncumbranceLevel(totalWeight, thresholds);
        var effectiveMA = encLevel.walkOnly ? 1 : Math.max(1, baseMA + encLevel.mod);

        // Update display
        document.getElementById(componentId + '-total-weight').textContent = totalWeight.toFixed(1);
        document.getElementById(componentId + '-pack-weight').textContent = packWeight.toFixed(1);

        var levelEl = document.getElementById(componentId + '-load-level');
        levelEl.textContent = encLevel.level;
        levelEl.className = 'enc-level level-' + encLevel.level.toLowerCase();

        var modEl = document.getElementById(componentId + '-ma-mod');
        modEl.textContent = encLevel.walkOnly ? 'Walk only' : encLevel.mod;

        document.getElementById(componentId + '-effective-ma').textContent = effectiveMA;

        updateMovementHexes(componentId, effectiveMA, encLevel);
        updatePackItemStyles(componentId, data.packDropped);
    }

    function updateMovementHexes(componentId, effectiveMA, encLevel) {
        var container = document.getElementById(componentId + '-container');
        var movementTable = container.querySelector('#' + componentId + '-movement-table');
        if (!movementTable) return;

        var runRow = movementTable.querySelector('tr[data-speed="run"]');
        var jogRow = movementTable.querySelector('tr[data-speed="jog"]');

        if (runRow) {
            var runHexes = runRow.querySelector('.current-hexes');
            if (encLevel.canRun) {
                runHexes.textContent = effectiveMA;
                runRow.style.opacity = '1';
            } else {
                runHexes.textContent = '—';
                runRow.style.opacity = '0.5';
            }
        }

        if (jogRow) {
            var jogHexes = jogRow.querySelector('.current-hexes');
            if (encLevel.canJog) {
                jogHexes.textContent = Math.floor(effectiveMA / 2);
                jogRow.style.opacity = '1';
            } else {
                jogHexes.textContent = '—';
                jogRow.style.opacity = '0.5';
            }
        }
    }

    function updatePackItemStyles(componentId, packDropped) {
        ['weapons', 'armour', 'misc'].forEach(function(cat) {
            var tbody = document.getElementById(componentId + '-' + cat + '-tbody');
            if (!tbody) return;
            tbody.querySelectorAll('tr').forEach(function(row) {
                if (row.dataset.inPack === 'true') {
                    row.classList.toggle('in-pack-item', packDropped);
                }
            });
        });
    }

    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function renderWeaponsTable(componentId) {
        var data = equipmentData[componentId] || getDefaultData();
        var tbody = document.getElementById(componentId + '-weapons-tbody');
        tbody.innerHTML = '';

        if (!data.weapons || data.weapons.length === 0) {
            var tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="11" style="text-align:center;color:#888;"><em>No weapons</em></td>';
            tbody.appendChild(tr);
            return;
        }

        data.weapons.forEach(function(item, index) {
            var tr = document.createElement('tr');
            tr.dataset.index = index;
            tr.dataset.inPack = item.inPack ? 'true' : 'false';
            if (!item.equipped) tr.classList.add('not-equipped');
            if (data.packDropped && item.inPack && item.equipped) tr.classList.add('in-pack-item');

            var equipChecked = item.equipped ? 'checked' : '';
            var packDisabled = item.equipped ? '' : 'disabled';
            var packChecked = item.inPack ? 'checked' : '';

            tr.innerHTML =
                '<td>' + escapeHtml(item.name) + '</td>' +
                '<td>' + escapeHtml(item.desc) + '</td>' +
                '<td style="text-align:center">' + escapeHtml(item.hit) + '</td>' +
                '<td style="text-align:center">' + escapeHtml(item.crit) + '</td>' +
                '<td style="text-align:center">' + escapeHtml(item.dmg) + '</td>' +
                '<td>' + (parseFloat(item.weight) || 0) + '</td>' +
                '<td>' + escapeHtml(item.value) + '</td>' +
                '<td class="equipped-toggle"><input type="checkbox" ' + equipChecked + ' onchange="EncumbranceCalc.toggleEquipped(\'' + componentId + '\', \'weapons\', ' + index + ')"></td>' +
                '<td class="pack-toggle-cell"><input type="checkbox" ' + packChecked + ' ' + packDisabled + ' onchange="EncumbranceCalc.toggleInPack(\'' + componentId + '\', \'weapons\', ' + index + ')"></td>' +
                '<td>' + escapeHtml(item.notes) + '</td>' +
                '<td><button type="button" class="btn-remove" onclick="EncumbranceCalc.removeItem(\'' + componentId + '\', \'weapons\', ' + index + ')">×</button></td>';

            tbody.appendChild(tr);
        });
    }

    function renderArmourTable(componentId) {
        var data = equipmentData[componentId] || getDefaultData();
        var tbody = document.getElementById(componentId + '-armour-tbody');
        tbody.innerHTML = '';

        if (!data.armour || data.armour.length === 0) {
            var tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="9" style="text-align:center;color:#888;"><em>No armour</em></td>';
            tbody.appendChild(tr);
            return;
        }

        data.armour.forEach(function(item, index) {
            var tr = document.createElement('tr');
            tr.dataset.index = index;
            tr.dataset.inPack = item.inPack ? 'true' : 'false';
            if (!item.equipped) tr.classList.add('not-equipped');
            if (data.packDropped && item.inPack && item.equipped) tr.classList.add('in-pack-item');

            var equipChecked = item.equipped ? 'checked' : '';
            var packDisabled = item.equipped ? '' : 'disabled';
            var packChecked = item.inPack ? 'checked' : '';

            tr.innerHTML =
                '<td>' + escapeHtml(item.name) + '</td>' +
                '<td>' + escapeHtml(item.desc) + '</td>' +
                '<td style="text-align:center">' + (item.absorb || 0) + '</td>' +
                '<td>' + (parseFloat(item.weight) || 0) + '</td>' +
                '<td>' + escapeHtml(item.value) + '</td>' +
                '<td class="equipped-toggle"><input type="checkbox" ' + equipChecked + ' onchange="EncumbranceCalc.toggleEquipped(\'' + componentId + '\', \'armour\', ' + index + ')"></td>' +
                '<td class="pack-toggle-cell"><input type="checkbox" ' + packChecked + ' ' + packDisabled + ' onchange="EncumbranceCalc.toggleInPack(\'' + componentId + '\', \'armour\', ' + index + ')"></td>' +
                '<td>' + escapeHtml(item.notes) + '</td>' +
                '<td><button type="button" class="btn-remove" onclick="EncumbranceCalc.removeItem(\'' + componentId + '\', \'armour\', ' + index + ')">×</button></td>';

            tbody.appendChild(tr);
        });
    }

    function renderMiscTable(componentId) {
        var data = equipmentData[componentId] || getDefaultData();
        var tbody = document.getElementById(componentId + '-misc-tbody');
        tbody.innerHTML = '';

        if (!data.misc || data.misc.length === 0) {
            var tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="8" style="text-align:center;color:#888;"><em>No items</em></td>';
            tbody.appendChild(tr);
            return;
        }

        data.misc.forEach(function(item, index) {
            var tr = document.createElement('tr');
            tr.dataset.index = index;
            tr.dataset.inPack = item.inPack ? 'true' : 'false';
            if (!item.equipped) tr.classList.add('not-equipped');
            if (data.packDropped && item.inPack && item.equipped) tr.classList.add('in-pack-item');

            var equipChecked = item.equipped ? 'checked' : '';
            var packDisabled = item.equipped ? '' : 'disabled';
            var packChecked = item.inPack ? 'checked' : '';

            tr.innerHTML =
                '<td>' + escapeHtml(item.name) + '</td>' +
                '<td>' + escapeHtml(item.desc) + '</td>' +
                '<td>' + escapeHtml(item.attrMod) + '</td>' +
                '<td>' + (parseFloat(item.weight) || 0) + '</td>' +
                '<td>' + escapeHtml(item.value) + '</td>' +
                '<td class="equipped-toggle"><input type="checkbox" ' + equipChecked + ' onchange="EncumbranceCalc.toggleEquipped(\'' + componentId + '\', \'misc\', ' + index + ')"></td>' +
                '<td class="pack-toggle-cell"><input type="checkbox" ' + packChecked + ' ' + packDisabled + ' onchange="EncumbranceCalc.toggleInPack(\'' + componentId + '\', \'misc\', ' + index + ')"></td>' +
                '<td><button type="button" class="btn-remove" onclick="EncumbranceCalc.removeItem(\'' + componentId + '\', \'misc\', ' + index + ')">×</button></td>';

            tbody.appendChild(tr);
        });
    }

    function updateCategoryTotals(componentId) {
        var data = equipmentData[componentId] || getDefaultData();

        // Calculate totals for each category
        var categories = ['weapons', 'armour', 'misc'];
        categories.forEach(function(cat) {
            var items = data[cat] || [];
            var totalWeight = 0;
            items.forEach(function(item) {
                totalWeight += parseFloat(item.weight) || 0;
            });
            var totalEl = document.getElementById(componentId + '-' + cat + '-total-weight');
            if (totalEl) {
                totalEl.textContent = totalWeight.toFixed(1);
            }
        });
    }

    function renderAllTables(componentId) {
        renderWeaponsTable(componentId);
        renderArmourTable(componentId);
        renderMiscTable(componentId);
        updateCategoryTotals(componentId);
    }

    function showAddForm(componentId, category) {
        var modal = document.getElementById(componentId + '-add-modal');
        var titleEl = document.getElementById(componentId + '-modal-title');
        var catInput = document.getElementById(componentId + '-item-category');

        // Set category
        catInput.value = category;

        // Update title
        var titles = { weapon: 'Add Weapon', armour: 'Add Armour', misc: 'Add Item' };
        titleEl.textContent = titles[category] || 'Add Item';

        // Show/hide category-specific fields
        var container = modal.querySelector('.modal-content');
        container.querySelector('.weapon-fields').style.display = category === 'weapon' ? 'flex' : 'none';
        container.querySelector('.armour-fields').style.display = category === 'armour' ? 'flex' : 'none';
        container.querySelector('.misc-fields').style.display = category === 'misc' ? 'flex' : 'none';
        container.querySelector('.notes-field').style.display = (category === 'weapon' || category === 'armour') ? 'block' : 'none';

        // Clear all inputs
        modal.querySelectorAll('input[type="text"], input[type="number"]').forEach(function(inp) {
            inp.value = '';
        });
        modal.querySelectorAll('input[type="checkbox"]').forEach(function(inp) {
            inp.checked = false;
        });

        // Show modal
        modal.style.display = 'flex';
    }

    function hideAddForm(componentId) {
        var modal = document.getElementById(componentId + '-add-modal');
        modal.style.display = 'none';
    }

    function saveItem(componentId) {
        var category = document.getElementById(componentId + '-item-category').value;
        var name = document.getElementById(componentId + '-item-name').value.trim();
        var desc = document.getElementById(componentId + '-item-desc').value.trim();
        var weight = parseFloat(document.getElementById(componentId + '-item-weight').value) || 0;
        var value = document.getElementById(componentId + '-item-value').value.trim();
        var equipped = document.getElementById(componentId + '-item-equipped').checked;
        var inPack = document.getElementById(componentId + '-item-inpack').checked;

        if (!name) {
            alert('Please enter an item name');
            return;
        }

        if (!equipmentData[componentId]) {
            equipmentData[componentId] = getDefaultData();
        }

        var item = {
            name: name,
            desc: desc,
            weight: weight,
            value: value,
            equipped: equipped,
            inPack: equipped ? inPack : false
        };

        // Add category-specific fields
        if (category === 'weapon') {
            item.hit = document.getElementById(componentId + '-item-hit').value.trim();
            item.crit = document.getElementById(componentId + '-item-crit').value.trim();
            item.dmg = document.getElementById(componentId + '-item-dmg').value.trim();
            item.notes = document.getElementById(componentId + '-item-notes').value.trim();
            equipmentData[componentId].weapons.push(item);
        } else if (category === 'armour') {
            item.absorb = parseInt(document.getElementById(componentId + '-item-absorb').value) || 0;
            item.notes = document.getElementById(componentId + '-item-notes').value.trim();
            equipmentData[componentId].armour.push(item);
        } else {
            item.attrMod = document.getElementById(componentId + '-item-attrmod').value.trim();
            equipmentData[componentId].misc.push(item);
        }

        hideAddForm(componentId);
        renderAllTables(componentId);
        calculateEncumbrance(componentId);
    }

    function removeItem(componentId, category, index) {
        if (!equipmentData[componentId]) return;
        equipmentData[componentId][category].splice(index, 1);
        renderAllTables(componentId);
        calculateEncumbrance(componentId);
    }

    function toggleEquipped(componentId, category, index) {
        if (!equipmentData[componentId]) return;
        var item = equipmentData[componentId][category][index];
        item.equipped = !item.equipped;
        if (!item.equipped) item.inPack = false; // Can't be in pack if not equipped
        renderAllTables(componentId);
        calculateEncumbrance(componentId);
    }

    function toggleInPack(componentId, category, index) {
        if (!equipmentData[componentId]) return;
        var item = equipmentData[componentId][category][index];
        item.inPack = !item.inPack;
        renderAllTables(componentId);
        calculateEncumbrance(componentId);
    }

    function togglePack(componentId) {
        var checkbox = document.getElementById(componentId + '-pack-dropped');
        if (!equipmentData[componentId]) {
            equipmentData[componentId] = getDefaultData();
        }
        equipmentData[componentId].packDropped = checkbox.checked;
        renderAllTables(componentId);
        calculateEncumbrance(componentId);
    }

    function init(componentId, initialData) {
        if (initialData && (initialData.weapons || initialData.armour || initialData.misc)) {
            // Convert saved format to internal format
            equipmentData[componentId] = {
                weapons: (initialData.weapons || []).map(function(w) {
                    return {
                        name: w.name || '',
                        desc: w.description || w.desc || '',
                        hit: w.hit || '',
                        crit: w.crit || '',
                        dmg: w.damage || w.dmg || '',
                        weight: parseFloat(w.weight) || 0,
                        value: w.value || '',
                        notes: w.notes || '',
                        equipped: w.equipped !== false,
                        inPack: w.inPack || false
                    };
                }),
                armour: (initialData.armour || []).map(function(a) {
                    return {
                        name: a.name || '',
                        desc: a.description || a.desc || '',
                        absorb: parseInt(a.absorb) || 0,
                        weight: parseFloat(a.weight) || 0,
                        value: a.value || '',
                        notes: a.notes || '',
                        equipped: a.equipped !== false,
                        inPack: a.inPack || false
                    };
                }),
                misc: (initialData.misc || []).map(function(m) {
                    return {
                        name: m.name || '',
                        desc: m.description || m.desc || '',
                        attrMod: m.attr_mod || m.attrMod || '',
                        weight: parseFloat(m.weight) || 0,
                        value: m.value || '',
                        equipped: m.equipped !== false,
                        inPack: m.inPack || false
                    };
                }),
                packDropped: false
            };
        } else if (!equipmentData[componentId]) {
            equipmentData[componentId] = getDefaultData();
        }
        renderAllTables(componentId);
        calculateEncumbrance(componentId);

        // Listen for equipped checkbox changes to enable/disable pack checkbox
        var modal = document.getElementById(componentId + '-add-modal');
        if (modal) {
            var equippedCheckbox = document.getElementById(componentId + '-item-equipped');
            var packField = modal.querySelector('.pack-field');
            var inPackCheckbox = document.getElementById(componentId + '-item-inpack');

            equippedCheckbox.addEventListener('change', function() {
                packField.style.display = this.checked ? 'block' : 'none';
                if (!this.checked) inPackCheckbox.checked = false;
            });
        }
    }

    return {
        init: init,
        showAddForm: showAddForm,
        hideAddForm: hideAddForm,
        saveItem: saveItem,
        removeItem: removeItem,
        toggleEquipped: toggleEquipped,
        toggleInPack: toggleInPack,
        togglePack: togglePack,
        recalculate: calculateEncumbrance
    };
})();

// Initialize EncumbranceCalc with saved equipment data
document.addEventListener('DOMContentLoaded', function() {
    var componentId = '{{ component_id|default:"cs" }}';
    var initialEquipment = {% if equipment_json %}{{ equipment_json }}{% else %}{}{% endif %};
    EncumbranceCalc.init(componentId, initialEquipment);
});
</script>
{% endif %}
