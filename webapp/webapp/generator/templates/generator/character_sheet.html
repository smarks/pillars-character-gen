{% extends "generator/base.html" %}

{% block title %}{{ character.name }} - Pillars{% endblock %}

{% block extra_css %}
/* Two-column layout */
.character-layout {
    display: flex;
    gap: 20px;
    align-items: flex-start;
}
.character-sidebar {
    width: 250px;
    flex-shrink: 0;
}
.character-main {
    flex: 1;
    max-width: 800px;
}
@media (max-width: 900px) {
    .character-layout {
        flex-direction: column;
    }
    .character-sidebar {
        width: 100%;
        order: -1;
    }
}

/* Sidebar styling */
.sidebar-section {
    margin-bottom: 20px;
    padding: 15px;
    border: 1px solid #ccc;
    background: #f9f9f9;
}
.sidebar-section h3 {
    margin: 0 0 10px 0;
    font-size: 1em;
    border-bottom: 1px solid #999;
    padding-bottom: 5px;
}

/* Track list in sidebar */
.track-legend {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}
.track-badge {
    padding: 2px 6px;
    font-size: 0.75em;
}
.track-badge.guaranteed { background: #4a4; color: white; }
.track-badge.roll-required { background: #fa0; color: black; }
.track-badge.impossible { background: #999; color: white; }

.track-list-compact {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.track-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 8px;
    border: 1px solid #ccc;
    font-size: 0.85em;
    cursor: pointer;
}
.track-item.guaranteed {
    background: #f0fff0;
    border-color: #4a4;
}
.track-item.roll-required {
    background: #fffaf0;
    border-color: #fa0;
}
.track-item.impossible {
    background: #f4f4f4;
    border-color: #ccc;
    opacity: 0.6;
    cursor: not-allowed;
}
.track-item.selected {
    border-color: #36c;
    border-width: 2px;
    background: #e8f0ff;
}
.track-item:hover:not(.impossible) {
    border-color: #36c;
}
.track-name {
    font-weight: bold;
}
.track-requirement {
    font-size: 0.75em;
    color: #666;
    margin-top: 2px;
}
.track-roll-info {
    font-size: 0.75em;
    color: #c60;
    font-style: italic;
    margin-top: 1px;
}
.track-details {
    display: flex;
    gap: 8px;
    font-size: 0.9em;
    color: #666;
    align-self: flex-start;
    margin-top: 3px;
}
.track-details .roll-note {
    color: #c60;
    font-style: italic;
}

.character-sheet {
    max-width: 800px;
}
.sheet-section {
    margin-bottom: 30px;
    padding: 15px;
    border: 1px solid #ccc;
    background: #fafafa;
}
.sheet-section h2 {
    margin-top: 0;
    border-bottom: 1px solid #999;
    padding-bottom: 10px;
}
.field-row {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    gap: 10px;
}
.field-row label {
    width: 120px;
    font-weight: bold;
}
.field-row input[type="text"],
.field-row input[type="number"] {
    font-family: monospace;
    font-size: 14px;
    padding: 5px 8px;
    border: 1px solid #ccc;
    background: #fff;
}
.field-row input[type="number"] {
    width: 60px;
}
.field-row input[type="text"] {
    flex: 1;
    max-width: 300px;
}
.field-row .computed {
    color: #666;
    font-style: italic;
}
.field-row .modifier {
    color: #666;
    font-size: 0.9em;
    margin-left: 5px;
}

/* Attribute grid */
.attributes-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
}
.attr-box {
    border: 1px solid #ddd;
    padding: 10px;
    background: #fff;
    text-align: center;
}
.attr-box label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
}
.attr-box input {
    width: 70px;
    text-align: center;
    font-size: 18px;
    font-weight: bold;
}
.attr-box input.invalid {
    border-color: #c44;
    background: #fee;
}
.attr-box .modifier {
    display: block;
    margin-top: 5px;
    font-size: 0.85em;
}

/* Derived stats */
.derived-stats {
    display: flex;
    gap: 30px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px dashed #ccc;
}
.derived-stat {
    text-align: center;
}
.derived-stat label {
    display: block;
    font-weight: bold;
}
.derived-stat .value {
    font-size: 20px;
    color: #333;
}

/* Skills list */
.skills-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
.skill-item {
    display: inline-block;
}
.skill-item .skill-display {
    background: #333;
    color: white;
    padding: 5px 12px;
    font-size: 0.9em;
    display: inline-block;
}
.add-skill-row {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px dashed #ccc;
}
.add-skill-row input {
    flex: 1;
    font-family: monospace;
    font-size: 14px;
    padding: 5px 8px;
    border: 1px solid #ccc;
}
.add-skill-row .btn-add {
    padding: 5px 15px;
    background: #4a4;
    color: white;
    border: none;
    cursor: pointer;
}
.add-skill-row .btn-add:hover {
    background: #3a3;
}

/* Notes textarea */
.notes-area {
    width: 100%;
    min-height: 100px;
    font-family: monospace;
    font-size: 14px;
    padding: 10px;
    border: 1px solid #ccc;
    resize: vertical;
}

/* Prior experience log */
.experience-log {
    font-size: 0.9em;
    background: #fff;
    padding: 10px;
    border: 1px solid #ddd;
    max-height: 300px;
    overflow-y: auto;
}
.experience-log .year-entry {
    padding: 5px 0;
    border-bottom: 1px dotted #ddd;
}
.experience-log .year-entry:last-child {
    border-bottom: none;
}
.experience-log .died {
    color: #c44;
    font-weight: bold;
}

/* Save indicator */
.save-indicator {
    position: fixed;
    top: 60px;
    right: 20px;
    padding: 8px 15px;
    border-radius: 4px;
    font-size: 14px;
    display: none;
    z-index: 1000;
}
.save-indicator.saving {
    display: block;
    background: #ffc;
    border: 1px solid #cc9;
    color: #663;
}
.save-indicator.saved {
    display: block;
    background: #cfc;
    border: 1px solid #9c9;
    color: #363;
}
.save-indicator.error {
    display: block;
    background: #fcc;
    border: 1px solid #c99;
    color: #633;
}

/* Field status */
input.saving, textarea.saving {
    background: #ffc !important;
}
input.saved, textarea.saved {
    background: #cfc !important;
}
input.error, textarea.error {
    background: #fcc !important;
}

/* Mobile styles for character sheet */
@media screen and (max-width: 768px) {
    .character-layout {
        flex-direction: column;
    }
    .character-sidebar {
        width: 100%;
        order: -1;
    }
    .character-main {
        max-width: 100%;
    }

    .sidebar-section {
        padding: 12px;
        margin-bottom: 15px;
    }

    .sheet-section {
        padding: 12px;
        margin-bottom: 20px;
    }

    /* Attributes grid - 2 columns on mobile */
    .attributes-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    .attr-box {
        padding: 8px;
    }
    .attr-box input {
        width: 60px;
        font-size: 16px;
    }

    /* Derived stats - wrap */
    .derived-stats {
        flex-wrap: wrap;
        gap: 15px;
    }

    /* Field rows - stack */
    .field-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
    .field-row label {
        width: auto;
    }
    .field-row input[type="text"],
    .field-row input[type="number"] {
        width: 100%;
        max-width: none;
        padding: 10px 8px;
        font-size: 16px;
        box-sizing: border-box;
    }

    /* Skills */
    .skill-item .skill-display {
        padding: 6px 10px;
        font-size: 13px;
    }
    .add-skill-row {
        flex-direction: column;
    }
    .add-skill-row input {
        width: 100%;
        padding: 10px 8px;
        font-size: 16px;
        box-sizing: border-box;
    }
    .add-skill-row .btn-add {
        width: 100%;
        padding: 10px;
    }

    /* Notes */
    .notes-area {
        font-size: 16px;
        padding: 10px;
    }

    /* Track items */
    .track-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
        padding: 10px;
    }
    .track-requirement {
        font-size: 0.7em;
    }
    .track-roll-info {
        font-size: 0.7em;
    }

    /* Save indicator - adjust position */
    .save-indicator {
        top: 10px;
        right: 10px;
        left: 10px;
        text-align: center;
    }

    /* Experience log */
    .experience-log {
        max-height: 200px;
        font-size: 0.85em;
    }
}

/* Very small screens */
@media screen and (max-width: 480px) {
    /* Single column attributes */
    .attributes-grid {
        grid-template-columns: 1fr;
    }

    .attr-box {
        display: flex;
        align-items: center;
        justify-content: space-between;
        text-align: left;
        padding: 10px;
    }
    .attr-box label {
        margin-bottom: 0;
        margin-right: 10px;
    }
    .attr-box input {
        width: 70px;
    }
    .attr-box .modifier {
        margin-top: 0;
        margin-left: 10px;
    }

    .track-legend {
        flex-direction: column;
        gap: 3px;
    }
}

/* Export dropdown */
.export-dropdown {
    position: relative;
    display: inline-block;
    width: 100%;
}
.export-dropdown .dropdown-btn {
    width: 100%;
    padding: 8px 12px;
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    text-align: left;
}
.export-dropdown .dropdown-btn:hover {
    background: #e5e7eb;
}
.export-dropdown .dropdown-content {
    display: none;
    position: absolute;
    left: 0;
    right: 0;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    border-radius: 4px;
    z-index: 100;
}
.export-dropdown:hover .dropdown-content {
    display: block;
}
.export-dropdown .dropdown-content a,
.export-dropdown .dropdown-content button {
    display: block;
    width: 100%;
    padding: 10px 15px;
    color: #333;
    text-decoration: none;
    font-size: 0.9em;
    text-align: left;
    background: none;
    border: none;
    cursor: pointer;
    box-sizing: border-box;
}
.export-dropdown .dropdown-content a:hover,
.export-dropdown .dropdown-content button:hover {
    background: #f3f4f6;
}
{% endblock %}

{% block content %}
<div class="top-bar">
    <h1>
        {% if is_owner %}
        <input type="text" id="char-name" data-field="name" value="{{ character.name }}"
               placeholder="Character Name" style="font-size: 1.5em; font-weight: bold; border: none; background: transparent; width: 100%;">
        {% else %}
        {{ character.name }}
        <span style="font-size: 0.5em; font-weight: normal; color: #666;">({{ character_owner.username }}'s character)</span>
        {% endif %}
    </h1>
    <div>
    </div>
</div>

<div class="save-indicator" id="save-indicator">Saving...</div>

<div class="character-layout">
    <!-- Left Sidebar - Add Experience -->
    <div class="character-sidebar">
        {% if years_served > 0 %}
        <div class="sidebar-section">
            <h3>Prior Experience</h3>
            <div class="info-row">
                <span>Current Age:</span>
                <span><strong>{{ current_age }}</strong></span>
            </div>
            <div class="info-row">
                <span>Years Served:</span>
                <span><strong>{{ years_served }}</strong></span>
            </div>
            {% if char_data.skill_track %}
            <div class="info-row">
                <span>Track:</span>
                <span><strong>{{ char_data.skill_track.track }}</strong></span>
            </div>
            <div class="info-row">
                <span>Survivability:</span>
                <span><strong>{{ char_data.skill_track.survivability }}+</strong></span>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if not died %}
        <div class="sidebar-section">
            <h3>Add Experience</h3>
            <form method="post" action="{% url 'add_experience_to_character' character.id %}">
                {% csrf_token %}
                <div style="margin-bottom: 10px;">
                    <label style="display: block; margin-bottom: 5px;">Years:</label>
                    <select name="years" id="years-select" style="width: 100%; padding: 5px; font-family: monospace;">
                        <option value="1">1 year</option>
                        <option value="2">2 years</option>
                        <option value="3">3 years</option>
                        <option value="4">4 years</option>
                        <option value="5" selected>5 years</option>
                        <option value="6">6 years</option>
                        <option value="7">7 years</option>
                        <option value="8">8 years</option>
                        <option value="9">9 years</option>
                        <option value="10">10 years</option>
                    </select>
                    <label style="display: block; margin-top: 8px; font-size: 0.9em;">
                        <input type="checkbox" name="interactive_mode" id="interactive-checkbox">
                        Interactive Mode (year by year)
                    </label>
                </div>
                <div id="aging-warning" class="warning-box" style="display: none; margin-bottom: 10px;">
                    <strong>Aging Warning!</strong>
                    <p style="margin: 5px 0; font-size: 0.85em;">Adding <span id="aging-years"></span> years will push your character past age 34, resulting in aging penalties:</p>
                    <ul style="margin: 5px 0 5px 20px; font-size: 0.8em;">
                        <li>Age 35: STR -1, DEX -1</li>
                        <li>Age 39: CON -1</li>
                        <li>Age 67+: All attributes -1</li>
                    </ul>
                </div>
                {% if not char_data.skill_track %}
                <div style="margin-bottom: 10px;">
                    <label style="display: block; margin-bottom: 5px;">Track:</label>
                    <select name="track" id="track-select" style="width: 100%; padding: 5px; font-family: monospace;">
                        <option value="auto">Auto-select</option>
                        {% for track in track_info %}
                        {% if not track.impossible %}
                        <option value="{{ track.track_key }}">{{ track.track }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <button type="submit" class="btn primary" style="width: 100%;">Add Experience</button>
            </form>
        </div>
        {% endif %}

        {% if track_info %}
        <div class="sidebar-section">
            <h3>Available Tracks</h3>
            <div class="track-legend" style="font-size: 0.8em; margin-bottom: 10px;">
                <span class="track-badge guaranteed">Guaranteed</span>
                <span class="track-badge roll-required">Roll Required</span>
                <span class="track-badge impossible">Impossible</span>
            </div>
            <div class="track-list-compact">
                {% for track in track_info %}
                <div class="track-item {% if track.impossible %}impossible{% elif track.requires_roll and not track.auto_accept %}roll-required{% else %}guaranteed{% endif %}"
                     data-track="{{ track.track_key }}"
                     onclick="{% if not track.impossible %}selectTrack('{{ track.track_key }}'){% endif %}"
                     title="{{ track.requirement }}{% if track.roll_info %} - {{ track.roll_info }}{% endif %}">
                    <div>
                        <div class="track-name">{{ track.track }}</div>
                        <div class="track-requirement">{{ track.requirement }}</div>
                        {% if track.roll_info and not track.auto_accept %}
                        <div class="track-roll-info">{{ track.roll_info }}</div>
                        {% endif %}
                    </div>
                    <div class="track-details">
                        <span class="surv">{{ track.survivability }}+</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="sidebar-section">
            <h3>Export</h3>
            <div class="export-dropdown">
                <button type="button" class="dropdown-btn">Export &#9662;</button>
                <div class="dropdown-content">
                    <button type="button" onclick="exportMarkdown()">Copy as Markdown</button>
                    <a href="{% url 'export_character_pdf' character.id %}">Save as PDF</a>
                    <a href="{% url 'export_character_markdown' character.id %}">Save as Markdown</a>
                </div>
            </div>
        </div>

        {% if died %}
        <div class="sidebar-section" style="background: #fdd; border-color: #c44;">
            <h3 style="color: #c44;">Character Died</h3>
            <p style="margin: 0; font-size: 0.9em;">This character died during prior experience at age {{ current_age }}.</p>
        </div>
        {% endif %}
    </div>

    <!-- Main Character Sheet -->
    <div class="character-main">
        {% with component_id="character_sheet" editable=is_owner show_experience=True %}
        {% include "generator/partials/character_sheet_component.html" %}
        {% endwith %}
    </div><!-- end character-main -->
</div><!-- end character-layout -->

<script>
const CHARACTER_ID = {{ character.id }};
const CSRF_TOKEN = '{{ csrf_token }}';
const UPDATE_URL = '{% url "update_character" character.id %}';
const CURRENT_AGE = {{ current_age|default:16 }};

// Initialize the character sheet component
document.addEventListener('DOMContentLoaded', function() {
    // Initialize CharacterSheet component if we're the owner
    {% if is_owner %}
    if (typeof CharacterSheet !== 'undefined') {
        CharacterSheet.init('character_sheet', UPDATE_URL, CSRF_TOKEN);
    }
    {% endif %}

    // Character name field (outside the component)
    var charNameInput = document.getElementById('char-name');
    if (charNameInput) {
        var nameTimeout = null;
        charNameInput.addEventListener('input', function() {
            if (nameTimeout) clearTimeout(nameTimeout);
            nameTimeout = setTimeout(function() {
                saveCharacterName(charNameInput.value);
            }, 300);
        });
    }
});

function saveCharacterName(name) {
    fetch(UPDATE_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN
        },
        body: JSON.stringify({ field: 'name', value: name })
    })
    .then(function(response) { return response.json(); })
    .then(function(result) {
        var indicator = document.getElementById('save-indicator');
        if (result.success) {
            indicator.textContent = 'Saved';
            indicator.className = 'save-indicator saved';
            setTimeout(function() { indicator.className = 'save-indicator'; }, 2000);
        } else {
            indicator.textContent = 'Error saving name';
            indicator.className = 'save-indicator error';
        }
    });
}

// Aging warning and interactive mode functionality
(function() {
    var yearsSelect = document.getElementById('years-select');
    var interactiveCheckbox = document.getElementById('interactive-checkbox');
    var agingWarning = document.getElementById('aging-warning');
    var agingYearsSpan = document.getElementById('aging-years');

    function updateAgingWarning() {
        if (!agingWarning || !yearsSelect) return;

        // Hide warning if interactive mode is checked
        if (interactiveCheckbox && interactiveCheckbox.checked) {
            agingWarning.style.display = 'none';
            return;
        }

        var selectedYears = parseInt(yearsSelect.value) || 0;
        var finalAge = CURRENT_AGE + selectedYears;

        if (finalAge > 34 && CURRENT_AGE <= 34) {
            if (agingYearsSpan) agingYearsSpan.textContent = selectedYears;
            agingWarning.style.display = 'block';
        } else if (finalAge > 34 && CURRENT_AGE > 34) {
            // Already past 34, update message for additional aging
            if (agingYearsSpan) agingYearsSpan.textContent = selectedYears;
            var warningP = agingWarning.querySelector('p');
            if (warningP) {
                warningP.innerHTML = 'Adding <span id="aging-years">' + selectedYears + '</span> years will result in additional aging penalties (current age: ' + CURRENT_AGE + '):';
            }
            agingWarning.style.display = 'block';
        } else {
            agingWarning.style.display = 'none';
        }
    }

    if (yearsSelect) {
        yearsSelect.addEventListener('change', updateAgingWarning);
        updateAgingWarning();
    }

    // Disable years selector when interactive mode is checked
    if (interactiveCheckbox) {
        interactiveCheckbox.addEventListener('change', function() {
            yearsSelect.disabled = this.checked;
            updateAgingWarning();
        });
    }
})();

function exportMarkdown() {
    var name = document.getElementById('char-name');
    name = name ? name.value : 'Unnamed Character';

    var md = '# ' + name + '\n\n';

    // Attributes
    md += '## Attributes\n\n';
    md += '| Attr | Value | Mod |\n';
    md += '|------|-------|-----|\n';

    var attrs = ['STR', 'DEX', 'INT', 'WIS', 'CON', 'CHR'];
    attrs.forEach(function(attr) {
        var input = document.querySelector('[data-field="attributes.' + attr + '"]');
        var modSpan = document.querySelector('[data-computed="' + attr.toLowerCase() + '_mod"]');
        var val = input ? input.value : '-';
        var mod = modSpan ? modSpan.textContent : '(0)';
        md += '| ' + attr + ' | ' + val + ' | ' + mod + ' |\n';
    });

    var fatigue = document.querySelector('[data-computed="fatigue_points"]');
    var body = document.querySelector('[data-computed="body_points"]');
    md += '\n**Fatigue Points:** ' + (fatigue ? fatigue.textContent : '-') + '\n';
    md += '**Body Points:** ' + (body ? body.textContent : '-') + '\n\n';

    // Biographical
    md += '## Biographical\n\n';
    ['appearance', 'height', 'weight'].forEach(function(field) {
        var input = document.querySelector('[data-field="' + field + '"]');
        if (input && input.value) {
            md += '**' + field.charAt(0).toUpperCase() + field.slice(1) + ':** ' + input.value + '\n';
        }
    });
    md += '\n';

    // Background
    md += '## Background\n\n';
    ['provenance', 'location', 'literacy', 'wealth_level'].forEach(function(field) {
        var input = document.querySelector('[data-field="' + field + '"]');
        if (input) {
            var val = input.tagName === 'SELECT' ? input.options[input.selectedIndex].text : input.value;
            if (val) {
                var label = field.replace('_level', '').charAt(0).toUpperCase() + field.replace('_level', '').slice(1);
                md += '**' + label + ':** ' + val + '\n';
            }
        }
    });
    md += '\n';

    // Skills
    md += '## Skills\n\n';
    var skillItems = document.querySelectorAll('#character_sheet-skills-list .skill-tag');
    if (skillItems.length > 0) {
        skillItems.forEach(function(item) {
            md += '- ' + item.textContent + '\n';
        });
    } else {
        md += '_No skills_\n';
    }
    md += '\n';

    // Notes
    var notes = document.querySelector('[data-field="notes"]');
    if (notes && notes.value.trim()) {
        md += '## Notes\n\n' + notes.value + '\n';
    }

    // Copy to clipboard
    navigator.clipboard.writeText(md).then(function() {
        var indicator = document.getElementById('save-indicator');
        indicator.textContent = 'Markdown copied to clipboard!';
        indicator.className = 'save-indicator saved';
        setTimeout(function() { indicator.className = 'save-indicator'; }, 2000);
    }).catch(function() {
        var textarea = document.createElement('textarea');
        textarea.value = md;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);

        var indicator = document.getElementById('save-indicator');
        indicator.textContent = 'Markdown copied to clipboard!';
        indicator.className = 'save-indicator saved';
        setTimeout(function() { indicator.className = 'save-indicator'; }, 2000);
    });
}

function selectTrack(trackKey) {
    var select = document.getElementById('track-select');
    if (select) {
        select.value = trackKey;
    }

    document.querySelectorAll('.track-item').forEach(function(item) {
        item.classList.remove('selected');
        if (item.dataset.track === trackKey) {
            item.classList.add('selected');
        }
    });
}
</script>
{% endblock %}
