{% extends "generator/base.html" %}

{% block title %}{{ character.name }} - Pillars{% endblock %}

{% block extra_css %}
/* Two-column layout */
.character-layout {
    display: flex;
    gap: 20px;
    align-items: flex-start;
}
.character-sidebar {
    width: 250px;
    flex-shrink: 0;
}
.character-main {
    flex: 1;
    max-width: 800px;
}
@media (max-width: 900px) {
    .character-layout {
        flex-direction: column;
    }
    .character-sidebar {
        width: 100%;
        order: -1;
    }
}

/* Sidebar styling */
.sidebar-section {
    margin-bottom: 20px;
    padding: 15px;
    border: 1px solid #ccc;
    background: #f9f9f9;
}
.sidebar-section h3 {
    margin: 0 0 10px 0;
    font-size: 1em;
    border-bottom: 1px solid #999;
    padding-bottom: 5px;
}

/* Track list in sidebar */
.track-legend {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}
.track-badge {
    padding: 2px 6px;
    font-size: 0.75em;
}
.track-badge.guaranteed { background: #4a4; color: white; }
.track-badge.roll-required { background: #fa0; color: black; }
.track-badge.impossible { background: #999; color: white; }

.track-list-compact {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.track-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 8px;
    border: 1px solid #ccc;
    font-size: 0.85em;
    cursor: pointer;
}
.track-item.guaranteed {
    background: #f0fff0;
    border-color: #4a4;
}
.track-item.roll-required {
    background: #fffaf0;
    border-color: #fa0;
}
.track-item.impossible {
    background: #f4f4f4;
    border-color: #ccc;
    opacity: 0.6;
    cursor: not-allowed;
}
.track-item.selected {
    border-color: #36c;
    border-width: 2px;
    background: #e8f0ff;
}
.track-item:hover:not(.impossible) {
    border-color: #36c;
}
.track-name {
    font-weight: bold;
}
.track-requirement {
    font-size: 0.75em;
    color: #666;
    margin-top: 2px;
}
.track-roll-info {
    font-size: 0.75em;
    color: #c60;
    font-style: italic;
    margin-top: 1px;
}
.track-details {
    display: flex;
    gap: 8px;
    font-size: 0.9em;
    color: #666;
    align-self: flex-start;
    margin-top: 3px;
}
.track-details .roll-note {
    color: #c60;
    font-style: italic;
}

.character-sheet {
    max-width: 800px;
}
.sheet-section {
    margin-bottom: 30px;
    padding: 15px;
    border: 1px solid #ccc;
    background: #fafafa;
}
.sheet-section h2 {
    margin-top: 0;
    border-bottom: 1px solid #999;
    padding-bottom: 10px;
}
.field-row {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    gap: 10px;
}
.field-row label {
    width: 120px;
    font-weight: bold;
}
.field-row input[type="text"],
.field-row input[type="number"] {
    font-family: monospace;
    font-size: 14px;
    padding: 5px 8px;
    border: 1px solid #ccc;
    background: #fff;
}
.field-row input[type="number"] {
    width: 60px;
}
.field-row input[type="text"] {
    flex: 1;
    max-width: 300px;
}
.field-row .computed {
    color: #666;
    font-style: italic;
}
.field-row .modifier {
    color: #666;
    font-size: 0.9em;
    margin-left: 5px;
}

/* Attribute grid */
.attributes-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
}
.attr-box {
    border: 1px solid #ddd;
    padding: 10px;
    background: #fff;
    text-align: center;
}
.attr-box label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
}
.attr-box input {
    width: 70px;
    text-align: center;
    font-size: 18px;
    font-weight: bold;
}
.attr-box input.invalid {
    border-color: #c44;
    background: #fee;
}
.attr-box .modifier {
    display: block;
    margin-top: 5px;
    font-size: 0.85em;
}

/* Derived stats */
.derived-stats {
    display: flex;
    gap: 30px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px dashed #ccc;
}
.derived-stat {
    text-align: center;
}
.derived-stat label {
    display: block;
    font-weight: bold;
}
.derived-stat .value {
    font-size: 20px;
    color: #333;
}

/* Skills list */
.skills-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
.skill-item {
    display: inline-block;
}
.skill-item .skill-display {
    background: #333;
    color: white;
    padding: 5px 12px;
    font-size: 0.9em;
    display: inline-block;
}
.add-skill-row {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px dashed #ccc;
}
.add-skill-row input {
    flex: 1;
    font-family: monospace;
    font-size: 14px;
    padding: 5px 8px;
    border: 1px solid #ccc;
}
.add-skill-row .btn-add {
    padding: 5px 15px;
    background: #4a4;
    color: white;
    border: none;
    cursor: pointer;
}
.add-skill-row .btn-add:hover {
    background: #3a3;
}

/* Notes textarea */
.notes-area {
    width: 100%;
    min-height: 100px;
    font-family: monospace;
    font-size: 14px;
    padding: 10px;
    border: 1px solid #ccc;
    resize: vertical;
}

/* Prior experience log */
.experience-log {
    font-size: 0.9em;
    background: #fff;
    padding: 10px;
    border: 1px solid #ddd;
    max-height: 300px;
    overflow-y: auto;
}
.experience-log .year-entry {
    padding: 5px 0;
    border-bottom: 1px dotted #ddd;
}
.experience-log .year-entry:last-child {
    border-bottom: none;
}
.experience-log .died {
    color: #c44;
    font-weight: bold;
}

/* Save indicator */
.save-indicator {
    position: fixed;
    top: 60px;
    right: 20px;
    padding: 8px 15px;
    border-radius: 4px;
    font-size: 14px;
    display: none;
    z-index: 1000;
}
.save-indicator.saving {
    display: block;
    background: #ffc;
    border: 1px solid #cc9;
    color: #663;
}
.save-indicator.saved {
    display: block;
    background: #cfc;
    border: 1px solid #9c9;
    color: #363;
}
.save-indicator.error {
    display: block;
    background: #fcc;
    border: 1px solid #c99;
    color: #633;
}

/* Field status */
input.saving, textarea.saving {
    background: #ffc !important;
}
input.saved, textarea.saved {
    background: #cfc !important;
}
input.error, textarea.error {
    background: #fcc !important;
}

/* Mobile styles for character sheet */
@media screen and (max-width: 768px) {
    .character-layout {
        flex-direction: column;
    }
    .character-sidebar {
        width: 100%;
        order: -1;
    }
    .character-main {
        max-width: 100%;
    }

    .sidebar-section {
        padding: 12px;
        margin-bottom: 15px;
    }

    .sheet-section {
        padding: 12px;
        margin-bottom: 20px;
    }

    /* Attributes grid - 2 columns on mobile */
    .attributes-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    .attr-box {
        padding: 8px;
    }
    .attr-box input {
        width: 60px;
        font-size: 16px;
    }

    /* Derived stats - wrap */
    .derived-stats {
        flex-wrap: wrap;
        gap: 15px;
    }

    /* Field rows - stack */
    .field-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
    .field-row label {
        width: auto;
    }
    .field-row input[type="text"],
    .field-row input[type="number"] {
        width: 100%;
        max-width: none;
        padding: 10px 8px;
        font-size: 16px;
        box-sizing: border-box;
    }

    /* Skills */
    .skill-item .skill-display {
        padding: 6px 10px;
        font-size: 13px;
    }
    .add-skill-row {
        flex-direction: column;
    }
    .add-skill-row input {
        width: 100%;
        padding: 10px 8px;
        font-size: 16px;
        box-sizing: border-box;
    }
    .add-skill-row .btn-add {
        width: 100%;
        padding: 10px;
    }

    /* Notes */
    .notes-area {
        font-size: 16px;
        padding: 10px;
    }

    /* Track items */
    .track-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
        padding: 10px;
    }
    .track-requirement {
        font-size: 0.7em;
    }
    .track-roll-info {
        font-size: 0.7em;
    }

    /* Save indicator - adjust position */
    .save-indicator {
        top: 10px;
        right: 10px;
        left: 10px;
        text-align: center;
    }

    /* Experience log */
    .experience-log {
        max-height: 200px;
        font-size: 0.85em;
    }
}

/* Very small screens */
@media screen and (max-width: 480px) {
    /* Single column attributes */
    .attributes-grid {
        grid-template-columns: 1fr;
    }

    .attr-box {
        display: flex;
        align-items: center;
        justify-content: space-between;
        text-align: left;
        padding: 10px;
    }
    .attr-box label {
        margin-bottom: 0;
        margin-right: 10px;
    }
    .attr-box input {
        width: 70px;
    }
    .attr-box .modifier {
        margin-top: 0;
        margin-left: 10px;
    }

    .track-legend {
        flex-direction: column;
        gap: 3px;
    }
}
{% endblock %}

{% block content %}
<div class="top-bar">
    <h1>
        {% if is_owner %}
        <input type="text" id="char-name" data-field="name" value="{{ character.name }}"
               placeholder="Character Name" style="font-size: 1.5em; font-weight: bold; border: none; background: transparent; width: 100%;">
        {% else %}
        {{ character.name }}
        <span style="font-size: 0.5em; font-weight: normal; color: #666;">({{ character_owner.username }}'s character)</span>
        {% endif %}
    </h1>
    <div>
        <a href="{% url 'my_characters' %}" class="btn">&larr; {% if is_owner %}My Characters{% else %}All Characters{% endif %}</a>
        <button type="button" class="btn" onclick="exportMarkdown()">Export Markdown</button>
    </div>
</div>

<div class="save-indicator" id="save-indicator">Saving...</div>

<div class="character-layout">
    <!-- Left Sidebar - Add Experience -->
    <div class="character-sidebar">
        {% if years_served > 0 %}
        <div class="sidebar-section">
            <h3>Prior Experience</h3>
            <div class="info-row">
                <span>Current Age:</span>
                <span><strong>{{ current_age }}</strong></span>
            </div>
            <div class="info-row">
                <span>Years Served:</span>
                <span><strong>{{ years_served }}</strong></span>
            </div>
            {% if char_data.skill_track %}
            <div class="info-row">
                <span>Track:</span>
                <span><strong>{{ char_data.skill_track.track }}</strong></span>
            </div>
            <div class="info-row">
                <span>Survivability:</span>
                <span><strong>{{ char_data.skill_track.survivability }}+</strong></span>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if not died %}
        <div class="sidebar-section">
            <h3>Add Experience</h3>
            <form method="post" action="{% url 'add_experience_to_character' character.id %}">
                {% csrf_token %}
                <div style="margin-bottom: 10px;">
                    <label style="display: block; margin-bottom: 5px;">Years:</label>
                    <select name="years" id="years-select" style="width: 100%; padding: 5px; font-family: monospace;">
                        <option value="1">1 year</option>
                        <option value="2">2 years</option>
                        <option value="3">3 years</option>
                        <option value="4">4 years</option>
                        <option value="5" selected>5 years</option>
                    </select>
                </div>
                <div id="aging-warning" class="warning-box" style="display: none; margin-bottom: 10px;">
                    <strong>Aging Warning!</strong>
                    <p style="margin: 5px 0; font-size: 0.85em;">Adding <span id="aging-years"></span> years will result in aging penalties (age <span id="final-age"></span>).</p>
                </div>
                {% if not char_data.skill_track %}
                <div style="margin-bottom: 10px;">
                    <label style="display: block; margin-bottom: 5px;">Track:</label>
                    <select name="track" id="track-select" style="width: 100%; padding: 5px; font-family: monospace;">
                        <option value="auto">Auto-select</option>
                        {% for track in track_info %}
                        {% if not track.impossible %}
                        <option value="{{ track.track_key }}">{{ track.track }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <button type="submit" class="btn primary" style="width: 100%;">Add Experience</button>
            </form>
        </div>
        {% endif %}

        {% if track_info %}
        <div class="sidebar-section">
            <h3>Available Tracks</h3>
            <div class="track-legend" style="font-size: 0.8em; margin-bottom: 10px;">
                <span class="track-badge guaranteed">Guaranteed</span>
                <span class="track-badge roll-required">Roll Required</span>
                <span class="track-badge impossible">Impossible</span>
            </div>
            <div class="track-list-compact">
                {% for track in track_info %}
                <div class="track-item {% if track.impossible %}impossible{% elif track.requires_roll and not track.auto_accept %}roll-required{% else %}guaranteed{% endif %}"
                     data-track="{{ track.track_key }}"
                     onclick="{% if not track.impossible %}selectTrack('{{ track.track_key }}'){% endif %}"
                     title="{{ track.requirement }}{% if track.roll_info %} - {{ track.roll_info }}{% endif %}">
                    <div>
                        <div class="track-name">{{ track.track }}</div>
                        <div class="track-requirement">{{ track.requirement }}</div>
                        {% if track.roll_info and not track.auto_accept %}
                        <div class="track-roll-info">{{ track.roll_info }}</div>
                        {% endif %}
                    </div>
                    <div class="track-details">
                        <span class="surv">{{ track.survivability }}+</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="sidebar-section">
            <h3>Export</h3>
            <button type="button" class="btn" style="width: 100%;" onclick="exportMarkdown()">Copy as Markdown</button>
        </div>

        {% if died %}
        <div class="sidebar-section" style="background: #fdd; border-color: #c44;">
            <h3 style="color: #c44;">Character Died</h3>
            <p style="margin: 0; font-size: 0.9em;">This character died during prior experience at age {{ current_age }}.</p>
        </div>
        {% endif %}
    </div>

    <!-- Main Character Sheet -->
    <div class="character-main">
        <div class="character-sheet">
    <!-- Attributes Section -->
    <div class="sheet-section">
        <h2>Attributes</h2>
        <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">
            Values 1-18 are integers. Above 18, use decimal notation: 18.10, 18.20, ... 18.100 = 19
        </p>
        <div class="attributes-grid">
            <div class="attr-box">
                <label>STR</label>
                <input type="text" data-field="attributes.STR" data-attr="true" value="{{ str_display }}">
                <span class="modifier" data-computed="str_mod">({{ str_mod|default:"0" }})</span>
            </div>
            <div class="attr-box">
                <label>DEX</label>
                <input type="text" data-field="attributes.DEX" data-attr="true" value="{{ dex_display }}">
                <span class="modifier" data-computed="dex_mod">({{ dex_mod|default:"0" }})</span>
            </div>
            <div class="attr-box">
                <label>INT</label>
                <input type="text" data-field="attributes.INT" data-attr="true" value="{{ int_display }}">
                <span class="modifier" data-computed="int_mod">({{ int_mod|default:"0" }})</span>
            </div>
            <div class="attr-box">
                <label>WIS</label>
                <input type="text" data-field="attributes.WIS" data-attr="true" value="{{ wis_display }}">
                <span class="modifier" data-computed="wis_mod">({{ wis_mod|default:"0" }})</span>
            </div>
            <div class="attr-box">
                <label>CON</label>
                <input type="text" data-field="attributes.CON" data-attr="true" value="{{ con_display }}">
                <span class="modifier" data-computed="con_mod">({{ con_mod|default:"0" }})</span>
            </div>
            <div class="attr-box">
                <label>CHR</label>
                <input type="text" data-field="attributes.CHR" data-attr="true" value="{{ chr_display }}">
                <span class="modifier" data-computed="chr_mod">({{ chr_mod|default:"0" }})</span>
            </div>
        </div>
        <div class="derived-stats">
            <div class="derived-stat">
                <label>Fatigue Points</label>
                <span class="value" data-computed="fatigue_points">{{ char_data.attributes.fatigue_points }}</span>
            </div>
            <div class="derived-stat">
                <label>Body Points</label>
                <span class="value" data-computed="body_points">{{ char_data.attributes.body_points }}</span>
            </div>
        </div>
    </div>

    <!-- Biographical Section -->
    <div class="sheet-section">
        <h2>Biographical</h2>
        <div class="field-row">
            <label>Appearance:</label>
            <input type="text" data-field="appearance" value="{{ char_data.appearance }}">
        </div>
        <div class="field-row">
            <label>Height:</label>
            <input type="text" data-field="height" value="{{ char_data.height }}">
        </div>
        <div class="field-row">
            <label>Weight:</label>
            <input type="text" data-field="weight" value="{{ char_data.weight }}">
        </div>
    </div>

    <!-- Background Section -->
    <div class="sheet-section">
        <h2>Background</h2>
        <div class="field-row">
            <label>Provenance:</label>
            <input type="text" data-field="provenance" value="{{ char_data.provenance }}">
        </div>
        <div class="field-row">
            <label>Location:</label>
            <input type="text" data-field="location" value="{{ char_data.location }}">
        </div>
        <div class="field-row">
            <label>Literacy:</label>
            <input type="text" data-field="literacy" value="{{ char_data.literacy }}">
        </div>
        <div class="field-row">
            <label>Wealth:</label>
            <input type="text" data-field="wealth" value="{{ char_data.wealth }}">
        </div>
    </div>

    <!-- Skills Section -->
    <div class="sheet-section">
        <h2>Skills</h2>
        <ul class="skills-list" id="skills-list">
            {% for skill in skills %}
            <li class="skill-item">
                <span class="skill-display">{{ skill }}</span>
            </li>
            {% empty %}
            <li class="skill-item" id="no-skills-msg"><em>No skills yet</em></li>
            {% endfor %}
        </ul>
        <div class="add-skill-row">
            <input type="text" id="new-skill-input" placeholder="Add skill (e.g., Tracking)" onkeypress="if(event.key==='Enter'){addSkill();return false;}">
            <button type="button" class="btn-add" onclick="addSkill()">+ Add Skill</button>
        </div>
    </div>

    {% if char_data.skill_track %}
    <!-- Skill Track Section -->
    <div class="sheet-section">
        <h2>Skill Track</h2>
        <div class="field-row">
            <label>Track:</label>
            <span>{{ char_data.skill_track.track }}</span>
        </div>
        <div class="field-row">
            <label>Survivability:</label>
            <span>{{ char_data.skill_track.survivability }}+</span>
        </div>
        {% if char_data.skill_track.craft_type %}
        <div class="field-row">
            <label>Craft:</label>
            <span>{{ char_data.skill_track.craft_type }}</span>
        </div>
        {% endif %}
        {% if char_data.skill_track.magic_school %}
        <div class="field-row">
            <label>Magic School:</label>
            <span>{{ char_data.skill_track.magic_school }}</span>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if yearly_results %}
    <!-- Prior Experience Section -->
    <div class="sheet-section">
        <h2>Prior Experience</h2>
        <div class="field-row">
            <label>Starting Age:</label>
            <span>16</span>
        </div>
        <div class="field-row">
            <label>Current Age:</label>
            <span>{{ current_age }}</span>
        </div>
        <div class="field-row">
            <label>Years Served:</label>
            <span>{{ years_served }}</span>
        </div>
        {% if died %}
        <div class="field-row">
            <span class="died">DIED DURING PRIOR EXPERIENCE</span>
        </div>
        {% endif %}
        <h3>Year-by-Year Log</h3>
        <div class="experience-log">
            {% for yr in yearly_results %}
            <div class="year-entry {% if not yr.survived %}died{% endif %}">
                <strong>Year {{ yr.year }}:</strong> {{ yr.skill }} |
                Survival: {{ yr.surv_roll }}{% if yr.surv_mod >= 0 %}+{% endif %}{{ yr.surv_mod }}={{ yr.surv_total }} vs {{ yr.surv_target }}+
                [{% if yr.survived %}Survived{% else %}DIED{% endif %}]
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Notes Section -->
    <div class="sheet-section">
        <h2>Notes</h2>
        <textarea class="notes-area" data-field="notes" placeholder="Character backstory, notes, etc...">{{ char_data.notes|default:"" }}</textarea>
    </div>
        </div><!-- end character-sheet -->
    </div><!-- end character-main -->
</div><!-- end character-layout -->

<script>
const CHARACTER_ID = {{ character.id }};
const CSRF_TOKEN = '{{ csrf_token }}';
const UPDATE_URL = '{% url "update_character" character.id %}';
const CURRENT_AGE = {{ current_age|default:16 }};

// Aging warning functionality
(function() {
    const yearsSelect = document.getElementById('years-select');
    const agingWarning = document.getElementById('aging-warning');
    const agingYearsSpan = document.getElementById('aging-years');
    const finalAgeSpan = document.getElementById('final-age');

    function updateAgingWarning() {
        if (!agingWarning || !yearsSelect) return;

        const selectedYears = parseInt(yearsSelect.value) || 0;
        const finalAge = CURRENT_AGE + selectedYears;

        // Show warning if adding years would push past 34 (aging penalties start at 35)
        if (finalAge > 34) {
            if (agingYearsSpan) agingYearsSpan.textContent = selectedYears;
            if (finalAgeSpan) finalAgeSpan.textContent = finalAge;
            agingWarning.style.display = 'block';
        } else {
            agingWarning.style.display = 'none';
        }
    }

    if (yearsSelect) {
        yearsSelect.addEventListener('change', updateAgingWarning);
        // Initial check
        updateAgingWarning();
    }
})();

let saveTimeout = null;
const SAVE_DELAY = 300; // ms debounce

/**
 * Parse attribute value from display format.
 * Accepts: integers 1-18, or decimal notation like 18.10, 18.20, ... 18.100, 19.10, etc.
 * Returns: { valid: bool, value: string (the raw value to send to server) }
 */
function parseAttributeValue(str) {
    str = str.trim();

    // Check for decimal notation (e.g., 18.10, 19.50, 24.100)
    const decimalMatch = str.match(/^(\d+)\.(\d+)$/);
    if (decimalMatch) {
        const base = parseInt(decimalMatch[1], 10);
        const sub = parseInt(decimalMatch[2], 10);
        // Base must be >= 18, sub must be 10-100 in increments of 10
        if (base >= 18 && sub >= 10 && sub <= 100 && sub % 10 === 0) {
            return { valid: true, value: str };
        }
        return { valid: false, value: str };
    }

    // Check for plain integer
    const intMatch = str.match(/^(\d+)$/);
    if (intMatch) {
        const val = parseInt(intMatch[1], 10);
        if (val >= 1 && val <= 18) {
            return { valid: true, value: val };
        }
        // Allow integers > 18 as shorthand (will be stored as-is)
        if (val > 18) {
            return { valid: true, value: val };
        }
        return { valid: false, value: str };
    }

    return { valid: false, value: str };
}

/**
 * Validate attribute input and show visual feedback.
 */
function validateAttributeInput(element) {
    const result = parseAttributeValue(element.value);
    if (result.valid) {
        element.classList.remove('invalid');
    } else {
        element.classList.add('invalid');
    }
    return result;
}

// Initialize all editable fields
document.addEventListener('DOMContentLoaded', function() {
    // Regular input fields
    document.querySelectorAll('input[data-field], textarea[data-field]').forEach(function(input) {
        input.addEventListener('input', function() {
            // Validate attribute inputs
            if (this.dataset.attr === 'true') {
                validateAttributeInput(this);
            }
            debounceSave(this);
        });
        input.addEventListener('blur', function() {
            // Save immediately on blur
            if (saveTimeout) {
                clearTimeout(saveTimeout);
                saveTimeout = null;
            }
            saveField(this);
        });
    });
});

function debounceSave(element) {
    element.classList.add('saving');
    element.classList.remove('saved', 'error');

    if (saveTimeout) {
        clearTimeout(saveTimeout);
    }
    saveTimeout = setTimeout(function() {
        saveField(element);
    }, SAVE_DELAY);
}

function saveField(element) {
    const field = element.dataset.field;
    const index = element.dataset.index;
    let value = element.value;

    // For attribute inputs, validate and parse
    if (element.dataset.attr === 'true') {
        const result = parseAttributeValue(value);
        if (!result.valid) {
            element.classList.remove('saving');
            element.classList.add('error');
            const indicator = document.getElementById('save-indicator');
            indicator.textContent = 'Invalid attribute value';
            indicator.className = 'save-indicator error';
            return;
        }
        value = result.value;
    }

    const indicator = document.getElementById('save-indicator');
    indicator.textContent = 'Saving...';
    indicator.className = 'save-indicator saving';

    const data = { field: field, value: value };
    if (index !== undefined) {
        data.action = 'edit';
        data.index = parseInt(index, 10);
    }

    fetch(UPDATE_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN,
        },
        body: JSON.stringify(data),
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            element.classList.remove('saving');
            element.classList.add('saved');
            indicator.textContent = 'Saved';
            indicator.className = 'save-indicator saved';

            // Update computed fields if returned
            if (result.computed) {
                for (const [key, val] of Object.entries(result.computed)) {
                    const el = document.querySelector('[data-computed="' + key + '"]');
                    if (el) {
                        if (key.endsWith('_mod')) {
                            el.textContent = '(' + (val >= 0 ? '+' : '') + val + ')';
                        } else {
                            el.textContent = val;
                        }
                    }
                }
            }

            // Clear saved indicator after 2 seconds
            setTimeout(function() {
                element.classList.remove('saved');
                indicator.className = 'save-indicator';
            }, 2000);
        } else {
            element.classList.remove('saving');
            element.classList.add('error');
            indicator.textContent = 'Error: ' + (result.error || 'Save failed');
            indicator.className = 'save-indicator error';
        }
    })
    .catch(error => {
        element.classList.remove('saving');
        element.classList.add('error');
        indicator.textContent = 'Error: ' + error.message;
        indicator.className = 'save-indicator error';
    });
}

function addSkill() {
    const input = document.getElementById('new-skill-input');
    const skill = input.value.trim();
    if (!skill) return;

    const indicator = document.getElementById('save-indicator');
    indicator.textContent = 'Adding skill...';
    indicator.className = 'save-indicator saving';

    fetch(UPDATE_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN,
        },
        body: JSON.stringify({ field: 'skills', action: 'add', value: skill }),
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Clear input
            input.value = '';

            // If server returned consolidated skills, rebuild the entire list
            if (result.computed && result.computed.skills) {
                rebuildSkillsList(result.computed.skills);
            } else {
                // Fallback: just reload the page
                location.reload();
            }

            indicator.textContent = 'Skill added';
            indicator.className = 'save-indicator saved';
            setTimeout(function() { indicator.className = 'save-indicator'; }, 2000);
        } else {
            indicator.textContent = 'Error: ' + (result.error || 'Failed to add skill');
            indicator.className = 'save-indicator error';
        }
    })
    .catch(error => {
        indicator.textContent = 'Error: ' + error.message;
        indicator.className = 'save-indicator error';
    });
}

function rebuildSkillsList(skills) {
    const list = document.getElementById('skills-list');
    list.innerHTML = '';

    if (skills.length === 0) {
        const li = document.createElement('li');
        li.className = 'skill-item';
        li.id = 'no-skills-msg';
        li.innerHTML = '<em>No skills yet</em>';
        list.appendChild(li);
        return;
    }

    skills.forEach(function(skill, index) {
        const li = document.createElement('li');
        li.className = 'skill-item';
        // Skills are display-only since they come from consolidation
        li.innerHTML = '<span class="skill-display">' + escapeHtml(skill) + '</span>';
        list.appendChild(li);
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function exportMarkdown() {
    // Build markdown from current character data
    const name = document.getElementById('char-name').value || 'Unnamed Character';

    let md = `# ${name}\n\n`;

    // Attributes
    md += `## Attributes\n\n`;
    md += `| Attr | Value | Mod |\n`;
    md += `|------|-------|-----|\n`;

    const attrs = ['STR', 'DEX', 'INT', 'WIS', 'CON', 'CHR'];
    attrs.forEach(function(attr) {
        const input = document.querySelector('[data-field="attributes.' + attr + '"]');
        const modSpan = document.querySelector('[data-computed="' + attr.toLowerCase() + '_mod"]');
        const val = input ? input.value : '-';
        const mod = modSpan ? modSpan.textContent : '(0)';
        md += `| ${attr} | ${val} | ${mod} |\n`;
    });

    const fatigue = document.querySelector('[data-computed="fatigue_points"]');
    const body = document.querySelector('[data-computed="body_points"]');
    md += `\n**Fatigue Points:** ${fatigue ? fatigue.textContent : '-'}\n`;
    md += `**Body Points:** ${body ? body.textContent : '-'}\n\n`;

    // Biographical
    md += `## Biographical\n\n`;
    const bioFields = ['appearance', 'height', 'weight'];
    bioFields.forEach(function(field) {
        const input = document.querySelector('[data-field="' + field + '"]');
        if (input && input.value) {
            md += `**${field.charAt(0).toUpperCase() + field.slice(1)}:** ${input.value}\n`;
        }
    });
    md += '\n';

    // Background
    md += `## Background\n\n`;
    const bgFields = ['provenance', 'location', 'literacy', 'wealth'];
    bgFields.forEach(function(field) {
        const input = document.querySelector('[data-field="' + field + '"]');
        if (input && input.value) {
            md += `**${field.charAt(0).toUpperCase() + field.slice(1)}:** ${input.value}\n`;
        }
    });
    md += '\n';

    // Skills
    md += `## Skills\n\n`;
    const skillItems = document.querySelectorAll('#skills-list .skill-display');
    if (skillItems.length > 0) {
        skillItems.forEach(function(item) {
            md += `- ${item.textContent}\n`;
        });
    } else {
        md += `_No skills_\n`;
    }
    md += '\n';

    // Notes
    const notes = document.querySelector('[data-field="notes"]');
    if (notes && notes.value.trim()) {
        md += `## Notes\n\n${notes.value}\n`;
    }

    // Copy to clipboard
    navigator.clipboard.writeText(md).then(function() {
        const indicator = document.getElementById('save-indicator');
        indicator.textContent = 'Markdown copied to clipboard!';
        indicator.className = 'save-indicator saved';
        setTimeout(function() { indicator.className = 'save-indicator'; }, 2000);
    }).catch(function(err) {
        // Fallback
        const textarea = document.createElement('textarea');
        textarea.value = md;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);

        const indicator = document.getElementById('save-indicator');
        indicator.textContent = 'Markdown copied to clipboard!';
        indicator.className = 'save-indicator saved';
        setTimeout(function() { indicator.className = 'save-indicator'; }, 2000);
    });
}

function selectTrack(trackKey) {
    // Update the dropdown
    const select = document.getElementById('track-select');
    if (select) {
        select.value = trackKey;
    }

    // Update visual selection on track cards
    document.querySelectorAll('.track-item').forEach(function(item) {
        item.classList.remove('selected');
        if (item.dataset.track === trackKey) {
            item.classList.add('selected');
        }
    });
}
</script>
{% endblock %}
