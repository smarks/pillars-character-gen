{% extends "generator/base.html" %}
{% load skill_filters %}

{% block title %}Pillars Character Editor - Prior Experience{% endblock %}

{% block extra_css %}
.radio-group {
    display: flex;
    gap: 15px;
}
.radio-group label {
    font-weight: normal;
    display: flex;
    align-items: center;
    gap: 5px;
}
.track-list { display: grid; gap: 15px; margin-top: 15px; }
.track-card {
    border: 2px solid #ccc;
    padding: 15px;
    position: relative;
    background: #fafafa;
}
.track-card.available { border-color: #4a4; background: #f8fff8; cursor: pointer; }
.track-card.requires-roll { border-color: #fa0; background: #fffaf0; cursor: pointer; }
.track-card.impossible { border-color: #ccc; background: #f4f4f4; opacity: 0.6; }
.track-card.selected { border-color: #00f; border-width: 3px; background: #e8e8ff; }
.track-card h4 { margin: 0 0 10px 0; }
.track-card .details { font-size: 0.9em; color: #666; }
.track-card .requirement { font-style: italic; margin: 5px 0; }
.track-card .roll-info { color: #c60; font-weight: bold; }
.track-card .skills { margin-top: 10px; }
.track-card input[type="radio"] {
    position: absolute;
    top: 15px;
    right: 15px;
    transform: scale(1.5);
}
.track-card.impossible input[type="radio"] { display: none; }
.track-card label { display: block; cursor: pointer; }
.track-card.impossible label { cursor: not-allowed; }
.status-badge {
    display: inline-block;
    padding: 2px 8px;
    font-size: 0.8em;
    margin-left: 10px;
}
.status-badge.guaranteed { background: #4a4; color: white; }
.status-badge.roll-required { background: #fa0; color: black; }
.status-badge.impossible { background: #c44; color: white; }
.manual-track-section { display: none; }
.manual-track-section.show { display: block; }
{% endblock %}

{% block content %}
<div class="top-bar">
    <h1>Prior Experience</h1>
</div>

<!-- Character Stats -->
<div class="section">
    <h3>Your Character</h3>
    <pre>{{ character }}</pre>
</div>

{% if has_experience %}
<div class="section">
    <h3>Prior Experience ({{ current_track }} Track)</h3>
    <div class="info-row">
        <span>Years Completed:</span>
        <span><strong>{{ years_completed }}</strong></span>
    </div>
    <div class="info-row">
        <span>Current Age:</span>
        <span><strong>{{ years_completed|add:16 }}</strong></span>
    </div>
    {% if died %}
    <div class="danger-box">
        <strong>CHARACTER DIED</strong> during prior experience!
    </div>
    {% endif %}
    {% if skills %}
    <p><strong>Skills Gained:</strong></p>
    <div class="skills-list">
        {% for skill in skills|consolidate_skills %}
        <span class="skill-tag">{{ skill }}</span>
        {% endfor %}
    </div>
    {% endif %}
    {% if yearly_results %}
    <h4 style="margin-top: 15px;">Year-by-Year Log</h4>
    <div class="experience-log" style="font-size: 0.9em; background: #fff; padding: 10px; border: 1px solid #ddd; max-height: 300px; overflow-y: auto;">
        {% for yr in yearly_results %}
        <div class="year-entry {% if not yr.survived %}died{% endif %}" style="padding: 5px 0; border-bottom: 1px dotted #ddd;">
            <strong>Year {{ yr.year }}:</strong> {{ yr.skill }} |
            Survival: {{ yr.surv_roll }}{% if yr.surv_mod >= 0 %}+{% endif %}{{ yr.surv_mod }}={{ yr.surv_total }} vs {{ yr.surv_target }}+
            [{% if yr.survived %}<span style="color: green;">Survived</span>{% else %}<span style="color: red; font-weight: bold;">DIED</span>{% endif %}]
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}

<form method="post" id="experience-form">
    {% csrf_token %}


    {% if error %}
    <div class="danger-box">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    {% if acceptance_failed %}
    <div class="warning-box">
        <h4>Acceptance Roll Failed!</h4>
        <p>You attempted to join the <strong>{{ failed_track }}</strong> track but failed the acceptance roll.</p>
        <p><strong>Result:</strong> {{ acceptance_check.reason }}</p>
        {% if acceptance_check.roll %}
        <p>Roll: {{ acceptance_check.roll }} vs target {{ acceptance_check.target }}+</p>
        {% endif %}
        <p>You may select a different track or try again (the dice will be re-rolled).</p>
    </div>
    {% endif %}

    {% if not has_experience %}
    <!-- Manual Track Selection (shown when manual mode selected) -->
    <div class="section manual-track-section" id="manual-track-section">
        <h3>Select Your Track</h3>
        <p>Choose a track for your character. Some tracks require meeting certain requirements or passing an acceptance roll.</p>

        <div class="info-box">
            <strong>Legend:</strong>
            <span class="status-badge guaranteed">Guaranteed</span> - No requirements
            <span class="status-badge roll-required">Roll Required</span> - Must pass dice roll
            <span class="status-badge impossible">Impossible</span> - Cannot qualify
        </div>

        <div class="track-list">
            {% for track in track_info %}
            <div class="track-card {% if track.impossible %}impossible{% elif track.requires_roll %}requires-roll{% else %}available{% endif %}">
                <label>
                    <h4>
                        {{ track.track }}
                        {% if track.impossible %}
                        <span class="status-badge impossible">Impossible</span>
                        {% elif track.requires_roll %}
                        <span class="status-badge roll-required">Roll Required</span>
                        {% else %}
                        <span class="status-badge guaranteed">Guaranteed</span>
                        {% endif %}
                    </h4>
                    {% if not track.impossible %}
                    <input type="radio" name="chosen_track" value="{{ track.track_key }}">
                    {% endif %}
                    <div class="details">
                        <p class="requirement"><strong>Requirement:</strong> {{ track.requirement }}</p>
                        {% if track.roll_info and not track.auto_accept %}
                        <p class="roll-info">{{ track.roll_info }}</p>
                        {% endif %}
                        <p><strong>Survivability:</strong> {{ track.survivability }}+</p>
                        <div class="skills">
                            <strong>Initial Skills:</strong>
                            {% if track.initial_skills %}
                            {{ track.initial_skills|join:", " }}
                            {% else %}
                            <em>None</em>
                            {% endif %}
                        </div>
                    </div>
                </label>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Track Reference (shown when auto mode) -->
    <div class="section" id="track-reference-section">
        <h3>Available Skill Tracks (Reference)</h3>
        <p>The system will auto-select the best available track for your character based on their attributes.</p>

        <div class="info-box">
            <strong>Legend:</strong>
            <span class="status-badge guaranteed">Guaranteed</span> - No requirements
            <span class="status-badge roll-required">Roll Required</span> - Must pass dice roll
            <span class="status-badge impossible">Impossible</span> - Cannot qualify
        </div>

        <div class="track-list">
            {% for track in track_info %}
            <div class="track-card {% if track.impossible %}impossible{% elif track.requires_roll %}requires-roll{% else %}available{% endif %}">
                <h4>
                    {{ track.track }}
                    {% if track.impossible %}
                    <span class="status-badge impossible">Impossible</span>
                    {% elif track.requires_roll %}
                    <span class="status-badge roll-required">Roll Required</span>
                    {% else %}
                    <span class="status-badge guaranteed">Guaranteed</span>
                    {% endif %}
                </h4>
                <div class="details">
                    <p class="requirement"><strong>Requirement:</strong> {{ track.requirement }}</p>
                    {% if track.roll_info and not track.auto_accept %}
                    <p class="roll-info">{{ track.roll_info }}</p>
                    {% endif %}
                    <p><strong>Survivability:</strong> {{ track.survivability }}+</p>
                    <div class="skills">
                        <strong>Initial Skills:</strong>
                        {% if track.initial_skills %}
                        {{ track.initial_skills|join:", " }}
                        {% else %}
                        <em>None</em>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% include "generator/partials/control_section.html" %}

    {% if not has_experience %}
    <div class="section">
        <div class="control-row">
            <label>Track Selection:</label>
            <div class="radio-group">
                <label>
                    <input type="radio" name="track_mode" value="auto" checked>
                    Auto-select best track
                </label>
                <label>
                    <input type="radio" name="track_mode" value="manual">
                    Manually select track
                </label>
            </div>
        </div>
    </div>
    {% endif %}
</form>

<script>
// Toggle between auto and manual track selection display
document.querySelectorAll('input[name="track_mode"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        var manualSection = document.getElementById('manual-track-section');
        var referenceSection = document.getElementById('track-reference-section');
        if (this.value === 'manual') {
            manualSection.classList.add('show');
            referenceSection.style.display = 'none';
        } else {
            manualSection.classList.remove('show');
            referenceSection.style.display = 'block';
        }
    });
});

// Make clicking on track cards select the radio button
document.querySelectorAll('.track-card').forEach(function(card) {
    card.addEventListener('click', function(e) {
        var radio = this.querySelector('input[type="radio"]');
        if (radio && !this.classList.contains('impossible')) {
            radio.checked = true;
            // Add visual feedback
            document.querySelectorAll('.track-card').forEach(function(c) {
                c.classList.remove('selected');
            });
            this.classList.add('selected');
        }
    });
});
</script>
{% endblock %}
