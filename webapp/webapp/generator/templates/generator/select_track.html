{% extends "generator/base.html" %}
{% load skill_filters %}

{% block title %}Pillars Character Editor - Prior Experience{% endblock %}

{% block extra_css %}
.radio-group {
    display: flex;
    gap: 15px;
}
.radio-group label {
    font-weight: normal;
    display: flex;
    align-items: center;
    gap: 5px;
}
.track-list { display: grid; gap: 15px; margin-top: 15px; }
.track-card {
    border: 2px solid #ccc;
    padding: 15px;
    position: relative;
    cursor: pointer;
}
/* Survivability target colors: lower target = easier to survive (green), higher = harder (red) */
.track-card.surv-3 { background: #ccffcc; border-color: #66cc66; } /* Easiest - need 3+ */
.track-card.surv-4 { background: #e6ffcc; border-color: #99cc66; }
.track-card.surv-5 { background: #ffffcc; border-color: #cccc66; } /* Medium */
.track-card.surv-6 { background: #ffe6cc; border-color: #cc9966; }
.track-card.surv-7 { background: #ffcccc; border-color: #cc6666; } /* Hardest - need 7+ */
.track-card.selected { border-color: #00f; border-width: 3px; }
.track-card h4 { margin: 0 0 10px 0; }
.track-card .details { font-size: 0.9em; color: #666; }
.track-card .skills { margin-top: 10px; }
.track-card input[type="radio"] {
    position: absolute;
    top: 15px;
    right: 15px;
    transform: scale(1.5);
}
.track-card label { display: block; cursor: pointer; }
{% endblock %}

{% block content %}
<div class="top-bar">
    <h1>Prior Experience</h1>
</div>

<!-- Character Stats -->
<div class="section">
    <h3>Your Character</h3>
    <pre>{{ character }}</pre>
</div>

{% if has_experience %}
<div class="section">
    <h3>Prior Experience ({{ current_track }} Track)</h3>
    <div class="info-row">
        <span>Years Completed:</span>
        <span><strong>{{ years_completed }}</strong></span>
    </div>
    <div class="info-row">
        <span>Current Age:</span>
        <span><strong>{{ years_completed|add:16 }}</strong></span>
    </div>
    {% if died %}
    <div class="danger-box">
        <strong>CHARACTER DIED</strong> during prior experience!
    </div>
    {% endif %}
    {% if skills %}
    <p><strong>Skills Gained:</strong></p>
    <div class="skills-list">
        {% for skill in skills|consolidate_skills %}
        <span class="skill-tag">{{ skill }}</span>
        {% endfor %}
    </div>
    {% endif %}
    {% if yearly_results %}
    <h4 style="margin-top: 15px;">Year-by-Year Log</h4>
    <div class="experience-log" style="font-size: 0.9em; background: #fff; padding: 10px; border: 1px solid #ddd; max-height: 300px; overflow-y: auto;">
        {% for yr in yearly_results %}
        <div class="year-entry {% if not yr.survived %}died{% endif %}" style="padding: 5px 0; border-bottom: 1px dotted #ddd;">
            <strong>Year {{ yr.year }}:</strong> {{ yr.skill }} |
            Survival: {{ yr.surv_roll }}{% if yr.surv_mod >= 0 %}+{% endif %}{{ yr.surv_mod }}={{ yr.surv_total }} vs {{ yr.surv_target }}+
            [{% if yr.survived %}<span style="color: green;">Survived</span>{% else %}<span style="color: red; font-weight: bold;">DIED</span>{% endif %}]
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}

<form method="post" id="experience-form">
    {% csrf_token %}


    {% if error %}
    <div class="danger-box">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    {% if acceptance_failed %}
    <div class="warning-box">
        <h4>Acceptance Roll Failed!</h4>
        <p>You attempted to join the <strong>{{ failed_track }}</strong> track but failed the acceptance roll.</p>
        <p><strong>Result:</strong> {{ acceptance_check.reason }}</p>
        {% if acceptance_check.roll %}
        <p>Roll: {{ acceptance_check.roll }} vs target {{ acceptance_check.target }}+</p>
        {% endif %}
        <p>You may select a different track or try again (the dice will be re-rolled).</p>
    </div>
    {% endif %}

    <!-- Track Selection (always shown - can change track each time) -->
    <div class="section" id="track-section">
        <h3>Select Your Track{% if has_experience %} for Next Experience{% endif %}</h3>
        <p>{% if has_experience %}Choose a track for your next years of experience. You can continue with {{ current_track }} or switch to a different track.{% else %}Choose a track for your character. The recommended track is pre-selected based on your attributes.{% endif %}</p>

        <div class="track-list">
            {% for track in track_info %}
            <div class="track-card surv-{{ track.survivability }}{% if current_track == track.track or track.recommended and not current_track %} selected{% endif %}">
                <label>
                    <h4>{{ track.track }}</h4>
                    <input type="radio" name="chosen_track" value="{{ track.track_key }}"{% if current_track == track.track or track.recommended and not current_track %} checked{% endif %}>
                    <div class="details">
                        <p><strong>Survivability:</strong> {{ track.survivability }}+</p>
                        <div class="skills">
                            <strong>Initial Skills:</strong>
                            {% if track.initial_skills %}
                            {{ track.initial_skills|join:", " }}
                            {% else %}
                            <em>None</em>
                            {% endif %}
                        </div>
                    </div>
                </label>
            </div>
            {% endfor %}
        </div>
    </div>

    {% include "generator/partials/control_section.html" %}
</form>

<script>
// Make clicking on track cards select the radio button
document.querySelectorAll('.track-card').forEach(function(card) {
    card.addEventListener('click', function(e) {
        var radio = this.querySelector('input[type="radio"]');
        if (radio && !this.classList.contains('impossible')) {
            radio.checked = true;
            // Add visual feedback
            document.querySelectorAll('.track-card').forEach(function(c) {
                c.classList.remove('selected');
            });
            this.classList.add('selected');
        }
    });
});
</script>
{% endblock %}
