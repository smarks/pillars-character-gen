{% extends "generator/base.html" %}

{% block title %}Pillars Character Generator - Select Skill Track{% endblock %}

{% block extra_css %}
.track-list { display: grid; gap: 15px; }
.track-card {
    border: 2px solid #ccc;
    padding: 15px;
    position: relative;
    background: #fafafa;
}
.track-card.available { border-color: #4a4; background: #f8fff8; }
.track-card.requires-roll { border-color: #fa0; background: #fffaf0; }
.track-card.impossible { border-color: #ccc; background: #f4f4f4; opacity: 0.6; }
.track-card h4 { margin: 0 0 10px 0; }
.track-card .details { font-size: 0.9em; color: #666; }
.track-card .requirement { font-style: italic; margin: 5px 0; }
.track-card .roll-info { color: #c60; font-weight: bold; }
.track-card .skills { margin-top: 10px; }
.track-card input[type="radio"] {
    position: absolute;
    top: 15px;
    right: 15px;
    transform: scale(1.5);
}
.track-card.impossible input[type="radio"] { display: none; }
.track-card label { display: block; cursor: pointer; }
.track-card.impossible label { cursor: not-allowed; }
.status-badge {
    display: inline-block;
    padding: 2px 8px;
    font-size: 0.8em;
    margin-left: 10px;
}
.status-badge.guaranteed { background: #4a4; color: white; }
.status-badge.roll-required { background: #fa0; color: black; }
.status-badge.impossible { background: #c44; color: white; }
{% endblock %}

{% block content %}
<div class="top-bar">
    <h1>Select Skill Track</h1>
    <a href="{% url 'start_over' %}" class="btn danger">Start Over</a>
</div>

<div class="section">
    <h3>Your Character</h3>
    <details>
        <summary>View Character Details</summary>
        <pre>{{ character }}</pre>
    </details>
    <div class="info-row">
        <span>Mode:</span>
        <span><strong>{{ pending_mode|title }}</strong></span>
    </div>
    <div class="info-row">
        <span>Years of Prior Experience:</span>
        <span><strong>{{ pending_years }}</strong></span>
    </div>
</div>

{% if error %}
<div class="danger-box">
    <strong>Error:</strong> {{ error }}
</div>
{% endif %}

{% if acceptance_failed %}
<div class="warning-box">
    <h4>Acceptance Roll Failed!</h4>
    <p>You attempted to join the <strong>{{ failed_track }}</strong> track but failed the acceptance roll.</p>
    <p><strong>Result:</strong> {{ acceptance_check.reason }}</p>
    {% if acceptance_check.roll %}
    <p>Roll: {{ acceptance_check.roll }} vs target {{ acceptance_check.target }}+</p>
    {% endif %}
    <p>You may select a different track or try again (the dice will be re-rolled).</p>
</div>
{% endif %}

<div class="section">
    <h3>Available Skill Tracks</h3>
    <p>Select a track for your character. Some tracks require meeting certain requirements or passing an acceptance roll.</p>

    <div class="info-box">
        <strong>Legend:</strong>
        <span class="status-badge guaranteed">Guaranteed</span> - No requirements, automatic acceptance
        <span class="status-badge roll-required">Roll Required</span> - Must pass a dice roll for acceptance
        <span class="status-badge impossible">Impossible</span> - Character cannot qualify for this track
    </div>

    <form method="post">
        {% csrf_token %}
        <div class="track-list">
            {% for track in track_info %}
            <div class="track-card {% if track.impossible %}impossible{% elif track.requires_roll %}requires-roll{% else %}available{% endif %}">
                <label>
                    <h4>
                        {{ track.track }}
                        {% if track.impossible %}
                        <span class="status-badge impossible">Impossible</span>
                        {% elif track.requires_roll %}
                        <span class="status-badge roll-required">Roll Required</span>
                        {% else %}
                        <span class="status-badge guaranteed">Guaranteed</span>
                        {% endif %}
                    </h4>
                    {% if not track.impossible %}
                    <input type="radio" name="chosen_track" value="{{ track.track_key }}" {% if track.impossible %}disabled{% endif %}>
                    {% endif %}
                    <div class="details">
                        <p class="requirement"><strong>Requirement:</strong> {{ track.requirement }}</p>
                        {% if track.roll_info and not track.auto_accept %}
                        <p class="roll-info">{{ track.roll_info }}</p>
                        {% endif %}
                        <p><strong>Survivability:</strong> {{ track.survivability }}+</p>
                        <div class="skills">
                            <strong>Initial Skills:</strong>
                            {% if track.initial_skills %}
                            {{ track.initial_skills|join:", " }}
                            {% else %}
                            <em>None</em>
                            {% endif %}
                        </div>
                    </div>
                </label>
            </div>
            {% endfor %}
        </div>

        <div class="button-group" style="margin-top: 20px;">
            <button type="submit" name="action" value="select_track" class="primary">Select Track</button>
            <button type="submit" name="action" value="cancel" class="danger">Cancel & Start Over</button>
        </div>
    </form>
</div>
{% endblock %}
