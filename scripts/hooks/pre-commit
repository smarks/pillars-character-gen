#!/bin/bash
# Pre-commit hook that runs the same checks as CI/CD pipeline
# This ensures code quality before commits

set -e

# Get the repository root directory
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}Running pre-commit checks (same as CI/CD pipeline)...${NC}"
echo ""

# Check if .venv exists
if [ ! -d ".venv" ]; then
    echo -e "${RED}Error: Virtual environment not found.${NC}"
    echo "Please run: ./setup.sh"
    exit 1
fi

# Activate virtual environment
source .venv/bin/activate

# Set Django environment variables for tests (same as CI)
export DJANGO_SECRET_KEY="${DJANGO_SECRET_KEY:-test-secret-key-for-local-dev}"
export DJANGO_DEBUG="${DJANGO_DEBUG:-True}"
export DJANGO_ALLOWED_HOSTS="${DJANGO_ALLOWED_HOSTS:-localhost,127.0.0.1}"

# Track if any checks failed
FAILED=0

# Function to run a check and track failures
run_check() {
    local name="$1"
    shift
    echo -e "${YELLOW}=== $name ===${NC}"
    if "$@"; then
        echo -e "${GREEN}✓ $name passed${NC}"
        echo ""
    else
        echo -e "${RED}✗ $name failed${NC}"
        echo ""
        FAILED=1
    fi
}

# Auto-fix linting issues before checking
echo -e "${YELLOW}=== Auto-fixing linting issues ===${NC}"

# Get list of staged Python files (excluding migrations)
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(py)$' | grep -v migrations || true)

if [ -n "$STAGED_PY_FILES" ]; then
    # Check if ruff is available
    if python -m ruff --version >/dev/null 2>&1; then
        echo "Running ruff --fix on staged files..."
        for file in $STAGED_PY_FILES; do
            python -m ruff check --fix "$file" 2>/dev/null || true
        done
    else
        echo "Ruff not installed, skipping auto-fix (install with: uv pip install ruff)"
    fi
    
    # Check if black is available
    if python -m black --version >/dev/null 2>&1; then
        echo "Running black formatter on staged files..."
        for file in $STAGED_PY_FILES; do
            python -m black "$file" 2>/dev/null || true
        done
    else
        echo "Black not installed, skipping auto-fix (install with: uv pip install black)"
    fi
    
    # Re-stage any files that were auto-fixed
    FIXED_FILES=$(git diff --name-only)
    if [ -n "$FIXED_FILES" ]; then
        echo "Re-staging auto-fixed files..."
        for file in $FIXED_FILES; do
            # Only re-stage files that were already staged
            if echo "$STAGED_PY_FILES" | grep -q "^$file$"; then
                git add "$file" 2>/dev/null && echo "  Re-staged: $file" || true
            fi
        done
    fi
    echo ""
else
    echo "No staged Python files to fix."
    echo ""
fi

# 1. Check code formatting with black (same as CI lint job)
run_check "Black formatting check" \
    python -m black --check pillars/ tests/ webapp/ --exclude migrations

# 2. Lint with ruff (same as CI lint job)
if python -m ruff --version >/dev/null 2>&1; then
    run_check "Ruff linting" \
        python -m ruff check pillars/ tests/ webapp/ --exclude migrations
else
    echo -e "${YELLOW}=== Ruff linting ===${NC}"
    echo "Ruff not installed, skipping (install with: uv pip install ruff)"
    echo ""
fi

# 3. Run core library tests (same as CI test job)
run_check "Core library tests" \
    python -m pytest tests/ -v

# 4. Run Django webapp tests (same as CI test job)
run_check "Django webapp tests" \
    bash -c "cd webapp && export DJANGO_SECRET_KEY=\"${DJANGO_SECRET_KEY}\" && export DJANGO_DEBUG=\"${DJANGO_DEBUG}\" && export DJANGO_ALLOWED_HOSTS=\"${DJANGO_ALLOWED_HOSTS}\" && python manage.py migrate && python manage.py test --keepdb"

# 5. Optionally run E2E tests (skip by default as they're slower)
# Set SKIP_E2E=0 to enable: SKIP_E2E=0 git commit
if [ "${SKIP_E2E:-1}" = "0" ]; then
    echo -e "${YELLOW}=== E2E tests ===${NC}"
    if cd webapp && export DJANGO_SECRET_KEY="${DJANGO_SECRET_KEY}" && export DJANGO_DEBUG="${DJANGO_DEBUG}" && export DJANGO_ALLOWED_HOSTS="${DJANGO_ALLOWED_HOSTS}" && python manage.py test webapp.generator.ui_tests --keepdb; then
        echo -e "${GREEN}✓ E2E tests passed${NC}"
        echo ""
    else
        echo -e "${RED}✗ E2E tests failed${NC}"
        echo ""
        FAILED=1
    fi
    cd "$REPO_ROOT"
else
    echo -e "${YELLOW}=== E2E tests ===${NC}"
    echo "Skipping E2E tests (set SKIP_E2E=0 to enable)"
    echo ""
fi

# Final result
if [ $FAILED -eq 1 ]; then
    echo -e "${RED}❌ Pre-commit checks failed!${NC}"
    echo ""
    echo "Please fix the issues above before committing."
    echo ""
    echo "Quick fixes:"
    echo "  - Format code: ./lint.sh format"
    echo "  - Fix linting: ./lint.sh fix"
    echo "  - Run tests: ./test.sh"
    exit 1
else
    echo -e "${GREEN}✅ All pre-commit checks passed!${NC}"
    exit 0
fi

